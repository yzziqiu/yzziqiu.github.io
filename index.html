<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="A girl with a laptop">
<meta property="og:type" content="website">
<meta property="og:title" content="Izzy Notes">
<meta property="og:url" content="http://www.yisiqiu.com/index.html">
<meta property="og:site_name" content="Izzy Notes">
<meta property="og:description" content="A girl with a laptop">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Izzy Notes">
<meta name="twitter:description" content="A girl with a laptop">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.yisiqiu.com/"/>





  <title>Izzy Notes</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Izzy Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yisiqiu.com/2017/10/19/first-post/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Izzy Qiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/profile.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Izzy Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/19/first-post/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-19T21:00:06+08:00">
                2017-10-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>It’s my first post using Github Pages. A bit set moving my previous website to this blog. Since I cannot afford the server :(</p>
<p>Anyway, the topic of the blog won’t change. Hope everyone enjoy the photos and article here xD</p>
<p>Take heart!</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yisiqiu.com/2016/08/01/CentOS-on-Mac-5-OpenVSwitch＋mininet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Izzy Qiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/profile.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Izzy Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/01/CentOS-on-Mac-5-OpenVSwitch＋mininet/" itemprop="url">#CentOS on Mac#5.OpenVSwitch＋mininet </a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-01T10:15:33+08:00">
                2016-08-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#OpenVSwitch</p>
<blockquote>
<p>任务：<br>1.源码安装ovs<br>2.写基本的openflow条目控制网络包转发方向<br>3.minine环境下设计应用ovs</p>
</blockquote>
<p>##OpenVSwitch安装</p>
<p>Linux内核支持到4.1.25。<br>之前安装的是4.6.4<br>所以用系统原本的3.10.0</p>
<p>天才第一步：先好好看源码包里的README</p>
<p><strong>下载源码</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget http://openvswitch.org/releases/openvswitch-2.0.1.tar.gz</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160731121156096" alt="这里写图片描述"><br>！！注意！！下载前一定要了解自己内核支持的版本，这个在readme里都有写，切勿一味追求latest version</p>
<p>比如</p>
<blockquote>
<p>ovs版本｜系统内核<br>2.0.x     | 2.6.32 to 3.10</p>
</blockquote>
<p>解压</p>
<p><code>tar zxvf openvswitch-2.0.1.tar.gz</code></p>
<p><img src="http://img.blog.csdn.net/20160731121212951" alt="这里写图片描述"></p>
<p><strong>前期准备</strong><br>1.确保OVS正确运行的环境依赖，切换至root用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">yum update</div><div class="line">yum install -y build-essential (有则忽略)</div><div class="line">yum -y install openssl-devel wget kernel-devel</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160731121311296" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160731121322471" alt="这里写图片描述"><br>要求如下（可以通过xxx –version)查询</p>
<blockquote>
<p>gcc版本4.1或更高<br>pkg-config版本0.22或更高<br>autoconf版本2.64或更高<br>automake版本1.10或更高<br>m4版本1.42或更高<br>python2.X ,X&gt;4（不建议用python3.0以上的版本）</p>
</blockquote>
<p><img src="http://img.blog.csdn.net/20160731121720473" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160731121755881" alt="这里写图片描述"></p>
<p><strong>构建基于Linux内核的交换机</strong></p>
<p> <code>cd openvswitch-2.0.1</code></p>
<p> <code>./boot.sh</code></p>
<p> <img src="http://img.blog.csdn.net/20160731122105885" alt="这里写图片描述"><br>开始用了不匹配的2.5.0，不过这里结果基本一致，是在make时候出错的</p>
<p><code>make clean</code></p>
<p><code>./configure --with-linux=/lib/modules/</code>uname -r<code>/build</code><br><img src="http://img.blog.csdn.net/20160731121825770" alt="这里写图片描述"><br>内核版本</p>
<p><strong>编译并安装OVS 2.3.0</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make</div></pre></td></tr></table></figure>
<p>//make没有这么快的</p>
<p><img src="http://img.blog.csdn.net/20160731125148769" alt="这里写图片描述"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make install</div></pre></td></tr></table></figure>
<p>install要用root权限 su<br><img src="http://img.blog.csdn.net/20160731125403567" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160731125432744" alt="这里写图片描述"></p>
<blockquote>
<p>install 不通过 安装autoconf 和autonmake libtool rpm-build m4</p>
</blockquote>
<p><strong>安装并加载构建的内核模块</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">make modules_install</div><div class="line">/sbin/modprobe openvswitch</div></pre></td></tr></table></figure>
<p><strong>使用ovsdb工具初始化配置数据库</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir -p /usr/local/etc/openvswitch</div><div class="line">ovsdb-tool create /usr/local/etc/openvswitch/conf.db vswitchd/vswitch.ovsschema</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160731125628677" alt="这里写图片描述"></p>
<p><strong>启动配置数据库</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ovsdb-server --remote=punix:/usr/local/var/run/openvswitch/db.sock \</div><div class="line">                    --remote=db:Open_vSwitch,Open_vSwitch,manager_options \</div><div class="line">                    --private-key=db:Open_vSwitch,SSL,private_key \</div><div class="line">                    --certificate=db:Open_vSwitch,SSL,certificate \</div><div class="line">                    --bootstrap-ca-cert=db:Open_vSwitch,SSL,ca_cert \</div><div class="line">                    --pidfile —detach</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160731125741060" alt="这里写图片描述"></p>
<p><strong>初始化数据库</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ovs-vsctl --no-wait init</div></pre></td></tr></table></figure>
<p><strong>启动主进程</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ovs-vswitchd --pidfile —detach</div></pre></td></tr></table></figure>
<p><strong>查看OVS进程是否启动</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps aux|grep ovs</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160731125909124" alt="这里写图片描述"></p>
<p>##<strong>ovs应用</strong></p>
<p>例子：新建网桥br0并加入端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ovs-vsctl add-br br0</div><div class="line">ovs-vsctl add-port br0 eth0</div><div class="line">ovs-vsctl add-port br0 vif1.0</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160731130050111" alt="这里写图片描述"></p>
<p>应用场景：<br>1.常用：如删除网桥br0上挂接的eth0网络接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ovs-vsctl del-port br0 eth0</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160801100713008" alt="这里写图片描述"></p>
<p>2.新建网桥加入端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ovs-vsctl add-br ovs-switch</div><div class="line"></div><div class="line">ovs-vsctl add-port ovs-switch eth0 //port4</div></pre></td></tr></table></figure>
<p>自定义<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ovs-vsctl add-port ovs-switch p1 -- set Interface p1 ofport_request=101</div><div class="line">ovs-vsctl add-port ovs-switch p2 -- set Interface p2 ofport_request=102</div><div class="line">ovs-vsctl add-port ovs-switch p3 -- set Interface p3 ofport_request=103</div></pre></td></tr></table></figure></p>
<p>对于 internal 类型的的网络接口，OVS 会在 Linux 系统中创建一个可以用来收发数据的模拟网络设备。我们可以为这个网络设备配置 IP 地址、进行数据监听。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ovs-vsctl set Interface p1 type=internal</div><div class="line">ovs-vsctl set Interface p1 type=internal</div><div class="line">ovs-vsctl set Interface p3 type=internal</div><div class="line">ethtool -i p2</div><div class="line">ethtool -i p2</div><div class="line">ethtool -i p3</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160801100741723" alt="这里写图片描述"></p>
<p>3.创建虚拟网络空间<br>为了避免网络接口上的地址和本机已有网络地址冲突，创建一个虚拟网络空间 ns1，把 p1 接口移入网络空间 ns1，并配置 IP 地址为 192.168.1.101，另外两个同理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ip netns add ns1</div><div class="line">ip link set p1 netns ns1</div><div class="line">ip netns exec ns1 ip addr add 192.168.1.101/24 dev p1</div><div class="line">ip netns exec ns1 ifconfig p1 promisc up</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160801100821192" alt="这里写图片描述"></p>
<p>4.查看 OVS 交换机的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ovs-vsctl show</div></pre></td></tr></table></figure>
<p>查看 Open vSwitch 中的端口信息，获得交换机对应的 datapath ID （dpid），以及每个端口的 OpenFlow 端口编号，端口名称，当前状态。<br><img src="http://img.blog.csdn.net/20160801100845677" alt="这里写图片描述"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ovs-ofctl show ovs-switch</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20160801100914692" alt="这里写图片描述"><br>5.运行查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ovs-appctl fdb/show ovs-switch</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160801100949583" alt="这里写图片描述"></p>
<p>查看交换机所有table<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ovs-ofctl dump-tables ovs-switch</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20160801101007240" alt="这里写图片描述"><br>查看交换机中的所有流表项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">ovs−ofctl dump−flows ovs-switch</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160801101017388" alt="这里写图片描述"><br>6.屏蔽数据包<br>（1）屏蔽 STP 协议的广播数据包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ovs-ofctl add-flow ovs-switch &quot;table=0, dl_dst=01:80:c2:00:00:00/ff:ff:ff:ff:ff:f0, actions=drop&quot;</div></pre></td></tr></table></figure>
<p>（2）屏蔽所有进入 OVS 的以太网广播数据包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ovs-ofctl add-flow ovs-switch &quot;table=0, dl_src=01:00:00:00:00:00/01:00:00:00:00:00, actions=drop&quot;</div></pre></td></tr></table></figure>
<p>7.修改数据包<br>（1）添加新的 OpenFlow 条目，修改从端口 p1 收到的数据包的源地址为 9.181.137.1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ovs-ofctl add-flow ovs-switch &quot;priority=1 idle_timeout=0,\</div><div class="line">    in_port=101,actions=mod_nw_src:9.181.137.1,normal&quot;</div></pre></td></tr></table></figure>
<p>（2）从端口 p1（192.168.1.101）发送测试数据到端口 p3（192.168.1.103）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ip netns exec ns1 ping 192.168.1.103</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160801101209662" alt="这里写图片描述"></p>
<p>（3）再打开一个ssh终端运行tcpdump<br>在接收端口 p3 监控数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ip netns exec ns3 tcpdump -i p3 icmp</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160801101222219" alt="这里写图片描述"></p>
<p>8.重定向数据包<br>添加新的 OpenFlow 条目，重定向所有的 ICMP 数据包到端口 p2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ovs-ofctl add-flow ovs-switch idle_timeout=0,dl_type=0x0800,nw_proto=1,actions=output:102</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160801101324866" alt="这里写图片描述"></p>
<p>从端口 p1 （192.168.1.101）发送数据到端口 p3（192.168.1.103）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ip netns exec ns1 ping 192.168.1.103</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160801101354706" alt="这里写图片描述"><br>在端口 p2 上监控数据，发现数据包已被转发到端口 p2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">ip netns exec ns3 tcpdump -i p2 icmp</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160801101543757" alt="这里写图片描述"><br><em>取代make的rpm-build</em></p>
<p>因为前面的make经常出错，我在网上找到了rpm-build的方法。最终没有按照这个方法，但也顺带了解了rpm-build</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">//创建编译目录：mkdir -p ~/rpmbuild/SOURCES</div></pre></td></tr></table></figure>
<p> <img src="http://img.blog.csdn.net/20160801094909950" alt="这里写图片描述"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># cp ../openvswitch-2.5.0.tar.gz ~/rpmbuild/SOURCES/  //复制文件目录</div><div class="line"># cp rhel/openvswitch-kmod.files ~/rpmbuild/SOURCES/</div><div class="line"># cp rhel/openvswitch.spec ~/rpmbuild/SPECS/</div><div class="line"># rpmbuild  -ba ~/rpmbuild/SPECS/openvswitch.spec   rpmbuild则是用来将源代码打包成.rpm格式的工具。-ba 编译后做成*.rpm和src.rpm</div><div class="line">#cp rhel/openvswitch-kmod-rhel6.spec ~/rpmbuild/SPECS/</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160801100225657" alt="这里写图片描述"></p>
<p>#<strong>mininet</strong><br><strong>安装mininet模拟环境</strong><br>www.mininet.org<br>源码安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">git clone git://github.com/mininet/mininet</div><div class="line">cd mininet/util/</div><div class="line">./install.sh -a</div><div class="line">ls</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160801102049372" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160801102104841" alt="这里写图片描述"></p>
<p>###应用场景设置</p>
<p>Stochastic Switching using Open vSwitch in Mininet<br>随机交换模型（参考github）</p>
<p>1.修改select group type，修改程序<br>/home/parallels/openvswitch-2.0.1/ofproto／ofproto-dpif-xlate.c中<br>加入头文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include &lt;time.h&gt;</div></pre></td></tr></table></figure>
<p>添加全局变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">static bool is_srand_initialized = false;</div></pre></td></tr></table></figure>
<p>修改函数（注意要在程序前面加上函数调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">static void</div><div class="line">xlate_select_group(struct xlate_ctx *ctx, struct group_dpif *group)</div><div class="line">&#123;</div><div class="line">    struct flow_wildcards *wc = &amp;ctx-&gt;xout-&gt;wc;</div><div class="line">    const struct ofputil_bucket *bucket;</div><div class="line">    uint32_t basis;</div><div class="line"></div><div class="line">    // The following tells the caching code that every packet in</div><div class="line">    // the flow in question must go to the userspace &quot;slow path&quot;.</div><div class="line">    ctx-&gt;xout-&gt;slow |= SLOW_CONTROLLER;</div><div class="line"></div><div class="line">    basis = hash_bytes(ctx-&gt;xin-&gt;flow.dl_dst, sizeof ctx-&gt;xin-&gt;flow.dl_dst, 0);</div><div class="line">    bucket = group_best_live_bucket(ctx, group, basis);</div><div class="line">    if (bucket) &#123;</div><div class="line">        memset(&amp;wc-&gt;masks.dl_dst, 0xff, sizeof wc-&gt;masks.dl_dst);</div><div class="line">        xlate_group_bucket(ctx, bucket);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static const struct ofputil_bucket *</div><div class="line">group_best_live_bucket(const struct xlate_ctx *ctx,</div><div class="line">                   const struct group_dpif *group,</div><div class="line">                   uint32_t basis) // basis in not being used</div><div class="line">&#123;</div><div class="line">    uint32_t rand_num = 0, sum = 0;</div><div class="line">    const struct ofputil_bucket *bucket = NULL;</div><div class="line">    const struct list *buckets;</div><div class="line"></div><div class="line">    // initialize random seed once</div><div class="line">    if (!is_srand_initialized) &#123;</div><div class="line">        srand(time(NULL));</div><div class="line">        is_srand_initialized = true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // generate a random number in [1, 10]</div><div class="line">    rand_num = (rand() % 10) + 1;</div><div class="line"></div><div class="line">    group_dpif_get_buckets(group, &amp;buckets);</div><div class="line">    LIST_FOR_EACH (bucket, list_node, buckets) &#123;</div><div class="line">        if (bucket_is_alive(ctx, bucket, 0)) &#123;</div><div class="line">            sum += bucket-&gt;weight;</div><div class="line">            if (rand_num &lt;= sum) &#123;</div><div class="line">                return bucket; // return this bucket</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return bucket; // return NULL</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2.重置更新后的ovs（步骤基本同上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> cd openvswitch-2.0.1/</div><div class="line">./configure --prefix=/usr --with-linux=/lib/modules/`uname -r`/build</div><div class="line">make</div><div class="line">make install</div><div class="line">make modules_install</div><div class="line"></div><div class="line">//此处不同</div><div class="line">rmmod openvswitch</div><div class="line">depmod -a</div></pre></td></tr></table></figure>
<p>3.运行ovs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/init.d/openvswitch-switch start</div></pre></td></tr></table></figure>
<p>4.mininet测试拓扑（python脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/python</div><div class="line"></div><div class="line">&quot;&quot;&quot;Topology with 10 switches and 10 hosts</div><div class="line">&quot;&quot;&quot;</div><div class="line"></div><div class="line">from mininet.cli import CLI</div><div class="line">from mininet.topo import Topo</div><div class="line">from mininet.net import Mininet</div><div class="line">from mininet.link import TCLink</div><div class="line">from mininet.log import setLogLevel</div><div class="line"></div><div class="line">class CSLRTopo( Topo ):</div><div class="line"></div><div class="line">        def __init__( self ):</div><div class="line">                &quot;Create Topology&quot;</div><div class="line"></div><div class="line">                # Initialize topology</div><div class="line">                Topo.__init__( self )</div><div class="line"></div><div class="line">                # Add hosts</div><div class="line">                h0 = self.addHost( &apos;h0&apos; )</div><div class="line">                h1 = self.addHost( &apos;h1&apos; )</div><div class="line">                h2 = self.addHost( &apos;h2&apos; )</div><div class="line">                h3 = self.addHost( &apos;h3&apos; )</div><div class="line">                h4 = self.addHost( &apos;h4&apos; )</div><div class="line">                h5 = self.addHost( &apos;h5&apos; )</div><div class="line">                h6 = self.addHost( &apos;h6&apos; )</div><div class="line">                h7 = self.addHost( &apos;h7&apos; )</div><div class="line">                h8 = self.addHost( &apos;h8&apos; )</div><div class="line">                h9 = self.addHost( &apos;h9&apos; )</div><div class="line"></div><div class="line">                # Add switches</div><div class="line">                s0 = self.addSwitch( &apos;s0&apos;, listenPort=6634 )</div><div class="line">                s1 = self.addSwitch( &apos;s1&apos;, listenPort=6635 )</div><div class="line">                s2 = self.addSwitch( &apos;s2&apos;, listenPort=6636 )</div><div class="line">                s3 = self.addSwitch( &apos;s3&apos;, listenPort=6637 )</div><div class="line">                s4 = self.addSwitch( &apos;s4&apos;, listenPort=6638 )</div><div class="line">                s5 = self.addSwitch( &apos;s5&apos;, listenPort=6639 )</div><div class="line">                s6 = self.addSwitch( &apos;s6&apos;, listenPort=6640 )</div><div class="line">                s7 = self.addSwitch( &apos;s7&apos;, listenPort=6641 )</div><div class="line">                s8 = self.addSwitch( &apos;s8&apos;, listenPort=6642 )</div><div class="line">                s9 = self.addSwitch( &apos;s9&apos;, listenPort=6643 )</div><div class="line"></div><div class="line">                # Add links between hosts and switches</div><div class="line">                self.addLink( h0, s0 ) # h0-eth0 &lt;-&gt; s0-eth1</div><div class="line">                self.addLink( h1, s1 ) # h1-eth0 &lt;-&gt; s1-eth1</div><div class="line">                self.addLink( h2, s2 ) # h2-eth0 &lt;-&gt; s2-eth1</div><div class="line">                self.addLink( h3, s3 ) # h3-eth0 &lt;-&gt; s3-eth1</div><div class="line">                self.addLink( h4, s4 ) # h4-eth0 &lt;-&gt; s4-eth1</div><div class="line">                self.addLink( h5, s5 ) # h5-eth0 &lt;-&gt; s5-eth1</div><div class="line">                self.addLink( h6, s6 ) # h6-eth0 &lt;-&gt; s6-eth1</div><div class="line">                self.addLink( h7, s7 ) # h7-eth0 &lt;-&gt; s7-eth1</div><div class="line">                self.addLink( h8, s8 ) # h8-eth0 &lt;-&gt; s8-eth1</div><div class="line">                self.addLink( h9, s9 ) # h9-eth0 &lt;-&gt; s9-eth1</div><div class="line"></div><div class="line">                # Add links between switches, with bandwidth 100Mbps</div><div class="line">                self.addLink( s0, s1, bw=100 ) # s0-eth2 &lt;-&gt; s1-eth2, Bandwidth = 100Mbps</div><div class="line">                self.addLink( s0, s2, bw=100 ) # s0-eth3 &lt;-&gt; s2-eth2, Bandwidth = 100Mbps</div><div class="line">                self.addLink( s1, s2, bw=100 ) # s1-eth3 &lt;-&gt; s2-eth3, Bandwidth = 100Mbps</div><div class="line">                self.addLink( s2, s3, bw=100 ) # s2-eth4 &lt;-&gt; s3-eth2, Bandwidth = 100Mbps</div><div class="line">                self.addLink( s3, s4, bw=100 ) # s3-eth3 &lt;-&gt; s4-eth2, Bandwidth = 100Mbps</div><div class="line">                self.addLink( s3, s6, bw=100 ) # s3-eth4 &lt;-&gt; s6-eth2, Bandwidth = 100Mbps</div><div class="line">                self.addLink( s4, s5, bw=100 ) # s4-eth3 &lt;-&gt; s5-eth2, Bandwidth = 100Mbps</div><div class="line">                self.addLink( s5, s7, bw=100 ) # s5-eth3 &lt;-&gt; s7-eth2, Bandwidth = 100Mbps</div><div class="line">                self.addLink( s6, s7, bw=100 ) # s6-eth3 &lt;-&gt; s7-eth3, Bandwidth = 100Mbps</div><div class="line">                self.addLink( s7, s8, bw=100 ) # s7-eth4 &lt;-&gt; s8-eth2, Bandwidth = 100Mbps</div><div class="line">                self.addLink( s7, s9, bw=100 ) # s7-eth5 &lt;-&gt; s9-eth2, Bandwidth = 100Mbps</div><div class="line">                self.addLink( s8, s9, bw=100 ) # s8-eth3 &lt;-&gt; s9-eth3, Bandwidth = 100Mbps</div><div class="line"></div><div class="line">def run():</div><div class="line">        &quot;Create and configure network&quot;</div><div class="line">        topo = CSLRTopo()</div><div class="line">        net = Mininet( topo=topo, link=TCLink, controller=None )</div><div class="line"></div><div class="line">        # Set interface IP and MAC addresses for hosts</div><div class="line">        h0 = net.get( &apos;h0&apos; )</div><div class="line">        h0.intf( &apos;h0-eth0&apos; ).setIP( &apos;10.0.0.2&apos;, 24 )</div><div class="line">        h0.intf( &apos;h0-eth0&apos; ).setMAC( &apos;0A:00:00:02:00:00&apos; )</div><div class="line"></div><div class="line">        h1 = net.get( &apos;h1&apos; )</div><div class="line">        h1.intf( &apos;h1-eth0&apos; ).setIP( &apos;10.0.1.2&apos;, 24 )</div><div class="line">        h1.intf( &apos;h1-eth0&apos; ).setMAC( &apos;0A:00:01:02:00:00&apos; )</div><div class="line"></div><div class="line">        h2 = net.get( &apos;h2&apos; )</div><div class="line">        h2.intf( &apos;h2-eth0&apos; ).setIP( &apos;10.0.2.2&apos;, 24 )</div><div class="line">        h2.intf( &apos;h2-eth0&apos; ).setMAC( &apos;0A:00:02:02:00:00&apos; )</div><div class="line"></div><div class="line">        h3 = net.get( &apos;h3&apos; )</div><div class="line">        h3.intf( &apos;h3-eth0&apos; ).setIP( &apos;10.0.3.2&apos;, 24 )</div><div class="line">        h3.intf( &apos;h3-eth0&apos; ).setMAC( &apos;0A:00:03:02:00:00&apos; )</div><div class="line"></div><div class="line">        h4 = net.get( &apos;h4&apos; )</div><div class="line">        h4.intf( &apos;h4-eth0&apos; ).setIP( &apos;10.0.4.2&apos;, 24 )</div><div class="line">        h4.intf( &apos;h4-eth0&apos; ).setMAC( &apos;0A:00:04:02:00:00&apos; )</div><div class="line"></div><div class="line">        h5 = net.get( &apos;h5&apos; )</div><div class="line">        h5.intf( &apos;h5-eth0&apos; ).setIP( &apos;10.0.5.2&apos;, 24 )</div><div class="line">        h5.intf( &apos;h5-eth0&apos; ).setMAC( &apos;0A:00:05:02:00:00&apos; )</div><div class="line"></div><div class="line">        h6 = net.get( &apos;h6&apos; )</div><div class="line">        h6.intf( &apos;h6-eth0&apos; ).setIP( &apos;10.0.6.2&apos;, 24 )</div><div class="line">        h6.intf( &apos;h6-eth0&apos; ).setMAC( &apos;0A:00:06:02:00:00&apos; )</div><div class="line"></div><div class="line">        h7 = net.get( &apos;h7&apos; )</div><div class="line">        h7.intf( &apos;h7-eth0&apos; ).setIP( &apos;10.0.7.2&apos;, 24 )</div><div class="line">        h7.intf( &apos;h7-eth0&apos; ).setMAC( &apos;0A:00:07:02:00:00&apos; )</div><div class="line"></div><div class="line">        h8 = net.get( &apos;h8&apos; )</div><div class="line">        h8.intf( &apos;h8-eth0&apos; ).setIP( &apos;10.0.8.2&apos;, 24 )</div><div class="line">        h8.intf( &apos;h8-eth0&apos; ).setMAC( &apos;0A:00:08:02:00:00&apos; )</div><div class="line"></div><div class="line">        h9 = net.get( &apos;h9&apos; )</div><div class="line">        h9.intf( &apos;h9-eth0&apos; ).setIP( &apos;10.0.9.2&apos;, 24 )</div><div class="line">        h9.intf( &apos;h9-eth0&apos; ).setMAC( &apos;0A:00:09:02:00:00&apos; )</div><div class="line"></div><div class="line">        # Set interface MAC address for switches (NOTE: IP</div><div class="line">        # addresses are not assigned to switch interfaces)</div><div class="line">        s0 = net.get( &apos;s0&apos; )</div><div class="line">        s0.intf( &apos;s0-eth1&apos; ).setMAC( &apos;0A:00:00:01:00:01&apos; )</div><div class="line">        s0.intf( &apos;s0-eth2&apos; ).setMAC( &apos;0A:00:0A:01:00:02&apos; )</div><div class="line">        s0.intf( &apos;s0-eth3&apos; ).setMAC( &apos;0A:00:0B:01:00:03&apos; )</div><div class="line"></div><div class="line">        s1 = net.get( &apos;s1&apos; )</div><div class="line">        s1.intf( &apos;s1-eth1&apos; ).setMAC( &apos;0A:00:01:01:00:01&apos; )</div><div class="line">        s1.intf( &apos;s1-eth2&apos; ).setMAC( &apos;0A:00:0A:FE:00:02&apos; )</div><div class="line">        s1.intf( &apos;s1-eth3&apos; ).setMAC( &apos;0A:00:0C:01:00:03&apos; )</div><div class="line"></div><div class="line">        s2 = net.get( &apos;s2&apos; )</div><div class="line">        s2.intf( &apos;s2-eth1&apos; ).setMAC( &apos;0A:00:02:01:00:01&apos; )</div><div class="line">        s2.intf( &apos;s2-eth2&apos; ).setMAC( &apos;0A:00:0B:FE:00:02&apos; )</div><div class="line">        s2.intf( &apos;s2-eth3&apos; ).setMAC( &apos;0A:00:0D:01:00:03&apos; )</div><div class="line">        s2.intf( &apos;s2-eth4&apos; ).setMAC( &apos;0A:00:0C:FE:00:04&apos; )</div><div class="line"></div><div class="line">        s3 = net.get( &apos;s3&apos; )</div><div class="line">        s3.intf( &apos;s3-eth1&apos; ).setMAC( &apos;0A:00:03:01:00:01&apos; )</div><div class="line">        s3.intf( &apos;s3-eth2&apos; ).setMAC( &apos;0A:00:0D:FE:00:02&apos; )</div><div class="line">        s3.intf( &apos;s3-eth3&apos; ).setMAC( &apos;0A:00:0E:01:00:03&apos; )</div><div class="line">        s3.intf( &apos;s3-eth4&apos; ).setMAC( &apos;0A:00:0F:01:00:04&apos; )</div><div class="line"></div><div class="line">        s4 = net.get( &apos;s4&apos; )</div><div class="line">        s4.intf( &apos;s4-eth1&apos; ).setMAC( &apos;0A:00:04:01:00:01&apos; )</div><div class="line">        s4.intf( &apos;s4-eth2&apos; ).setMAC( &apos;0A:00:0E:FE:00:02&apos; )</div><div class="line">        s4.intf( &apos;s4-eth3&apos; ).setMAC( &apos;0A:00:10:01:00:03&apos; )</div><div class="line"></div><div class="line">        s5 = net.get( &apos;s5&apos; )</div><div class="line">        s5.intf( &apos;s5-eth1&apos; ).setMAC( &apos;0A:00:05:01:00:01&apos; )</div><div class="line">        s5.intf( &apos;s5-eth2&apos; ).setMAC( &apos;0A:00:10:FE:00:02&apos; )</div><div class="line">        s5.intf( &apos;s5-eth3&apos; ).setMAC( &apos;0A:00:11:01:00:03&apos; )</div><div class="line"></div><div class="line">        s6 = net.get( &apos;s6&apos; )</div><div class="line">        s6.intf( &apos;s6-eth1&apos; ).setMAC( &apos;0A:00:06:01:00:01&apos; )</div><div class="line">        s6.intf( &apos;s6-eth2&apos; ).setMAC( &apos;0A:00:0F:FE:00:02&apos; )</div><div class="line">        s6.intf( &apos;s6-eth3&apos; ).setMAC( &apos;0A:00:12:01:00:03&apos; )</div><div class="line"></div><div class="line">        s7 = net.get( &apos;s7&apos; )</div><div class="line">        s7.intf( &apos;s7-eth1&apos; ).setMAC( &apos;0A:00:07:01:00:01&apos; )</div><div class="line">        s7.intf( &apos;s7-eth2&apos; ).setMAC( &apos;0A:00:11:FE:00:02&apos; )</div><div class="line">        s7.intf( &apos;s7-eth3&apos; ).setMAC( &apos;0A:00:12:FE:00:03&apos; )</div><div class="line">        s7.intf( &apos;s7-eth4&apos; ).setMAC( &apos;0A:00:13:01:00:04&apos; )</div><div class="line">        s7.intf( &apos;s7-eth5&apos; ).setMAC( &apos;0A:00:14:01:00:05&apos; )</div><div class="line"></div><div class="line">        s8 = net.get( &apos;s8&apos; )</div><div class="line">        s8.intf( &apos;s8-eth1&apos; ).setMAC( &apos;0A:00:08:01:00:01&apos; )</div><div class="line">        s8.intf( &apos;s8-eth2&apos; ).setMAC( &apos;0A:00:13:FE:00:02&apos; )</div><div class="line">        s8.intf( &apos;s8-eth3&apos; ).setMAC( &apos;0A:00:15:01:00:03&apos; )</div><div class="line"></div><div class="line">        s9 = net.get( &apos;s9&apos; )</div><div class="line">        s9.intf( &apos;s9-eth1&apos; ).setMAC( &apos;0A:00:09:01:00:01&apos; )</div><div class="line">        s9.intf( &apos;s9-eth2&apos; ).setMAC( &apos;0A:00:14:FE:00:02&apos; )</div><div class="line">        s9.intf( &apos;s9-eth3&apos; ).setMAC( &apos;0A:00:15:FE:00:03&apos; )</div><div class="line"></div><div class="line">        net.start()</div><div class="line"></div><div class="line">        # Add routing table entries for hosts (NOTE: The gateway</div><div class="line">		# IPs 10.0.X.1 are not assigned to switch interfaces)</div><div class="line">        h0.cmd( &apos;route add default gw 10.0.0.1 dev h0-eth0&apos; )</div><div class="line">        h1.cmd( &apos;route add default gw 10.0.1.1 dev h1-eth0&apos; )</div><div class="line">        h2.cmd( &apos;route add default gw 10.0.2.1 dev h2-eth0&apos; )</div><div class="line">        h3.cmd( &apos;route add default gw 10.0.3.1 dev h3-eth0&apos; )</div><div class="line">        h4.cmd( &apos;route add default gw 10.0.4.1 dev h4-eth0&apos; )</div><div class="line">        h5.cmd( &apos;route add default gw 10.0.5.1 dev h5-eth0&apos; )</div><div class="line">        h6.cmd( &apos;route add default gw 10.0.6.1 dev h6-eth0&apos; )</div><div class="line">        h7.cmd( &apos;route add default gw 10.0.7.1 dev h7-eth0&apos; )</div><div class="line">        h8.cmd( &apos;route add default gw 10.0.8.1 dev h8-eth0&apos; )</div><div class="line">        h9.cmd( &apos;route add default gw 10.0.9.1 dev h9-eth0&apos; )</div><div class="line"></div><div class="line">        # Add arp cache entries for hosts</div><div class="line">        h0.cmd( &apos;arp -s 10.0.0.1 0A:00:00:01:00:01 -i h0-eth0&apos; )</div><div class="line">        h1.cmd( &apos;arp -s 10.0.1.1 0A:00:01:01:00:01 -i h1-eth0&apos; )</div><div class="line">        h2.cmd( &apos;arp -s 10.0.2.1 0A:00:02:01:00:01 -i h2-eth0&apos; )</div><div class="line">        h3.cmd( &apos;arp -s 10.0.3.1 0A:00:03:01:00:01 -i h3-eth0&apos; )</div><div class="line">        h4.cmd( &apos;arp -s 10.0.4.1 0A:00:04:01:00:01 -i h4-eth0&apos; )</div><div class="line">        h5.cmd( &apos;arp -s 10.0.5.1 0A:00:05:01:00:01 -i h5-eth0&apos; )</div><div class="line">        h6.cmd( &apos;arp -s 10.0.6.1 0A:00:06:01:00:01 -i h6-eth0&apos; )</div><div class="line">        h7.cmd( &apos;arp -s 10.0.7.1 0A:00:07:01:00:01 -i h7-eth0&apos; )</div><div class="line">        h8.cmd( &apos;arp -s 10.0.8.1 0A:00:08:01:00:01 -i h8-eth0&apos; )</div><div class="line">        h9.cmd( &apos;arp -s 10.0.9.1 0A:00:09:01:00:01 -i h9-eth0&apos; )</div><div class="line"></div><div class="line">        # Open Mininet Command Line Interface</div><div class="line">        CLI(net)</div><div class="line"></div><div class="line">        # Teardown and cleanup</div><div class="line">        net.stop()</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    setLogLevel(&apos;info&apos;)</div><div class="line">    run()</div></pre></td></tr></table></figure>
<p>在Mininet中测试拓扑脚本，生成10主机和10个交换拓扑结构。详细  IP/MAC 地址的拓扑如下</p>
<p><img src="http://img.blog.csdn.net/20160801103626439" alt="这里写图片描述"></p>
<p>5.设计openflow条目<br>打开终端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ovs-vsctl set bridge s0 protocols=OpenFlow13</div><div class="line">ovs-vsctl set bridge s1 protocols=OpenFlow13</div><div class="line">ovs-vsctl set bridge s2 protocols=OpenFlow13</div><div class="line">ovs-vsctl set bridge s3 protocols=OpenFlow13</div><div class="line">ovs-vsctl set bridge s4 protocols=OpenFlow13</div><div class="line">ovs-vsctl set bridge s5 protocols=OpenFlow13</div><div class="line">ovs-vsctl set bridge s6 protocols=OpenFlow13</div><div class="line">ovs-vsctl set bridge s7 protocols=OpenFlow13</div><div class="line">ovs-vsctl set bridge s8 protocols=OpenFlow13</div><div class="line">ovs-vsctl set bridge s9 protocols=OpenFlow13</div></pre></td></tr></table></figure>
<p>多路径随机交换思路</p>
<p>测试 multipath stochastic switching<br>从h0向h9发送数据包<br>（1）［s0, s2, s3, s6, s7, s9]<br>（2）  [s0, s2, s3, s6, s7, s8, s9]</p>
<p><img src="http://img.blog.csdn.net/20160801104106822" alt="这里写图片描述"></p>
<p>6.运行 xterm s0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"># ADD-GROUP at s7 for [0, 9]</div><div class="line"></div><div class="line">ovs-ofctl -O OpenFlow13 add-group tcp:127.0.0.1:6641 group_id=0,type=select,bucket=weight:7,mod_dl_src:0A:00:14:01:00:05,mod_dl_dst:0A:00:14:FE:00:02,output=5,bucket=weight:3,mod_dl_src:0A:00:13:01:00:04,mod_dl_dst:0A:00:13:FE:00:02,output=4</div><div class="line"></div><div class="line"># ADD-FLOW(s) for [0, 9] at [0, 2, 3, 6, 7, 8, 9]</div><div class="line"></div><div class="line">ovs-ofctl -O OpenFlow13 add-flow tcp:127.0.0.1:6634 in_port=1,ip,nw_src=10.0.0.2,nw_dst=10.0.9.2,actions=mod_dl_src:0A:00:0B:01:00:03,mod_dl_dst:0A:00:0B:FE:00:02,output=3</div><div class="line"></div><div class="line">ovs-ofctl -O OpenFlow13 add-flow tcp:127.0.0.1:6636 in_port=2,ip,nw_src=10.0.0.2,nw_dst=10.0.9.2,actions=mod_dl_src:0A:00:0D:01:00:04,mod_dl_dst:0A:00:0D:FE:00:02,output=4</div><div class="line"></div><div class="line">ovs-ofctl -O OpenFlow13 add-flow tcp:127.0.0.1:6637 in_port=2,ip,nw_src=10.0.0.2,nw_dst=10.0.9.2,actions=mod_dl_src:0A:00:0F:01:00:04,mod_dl_dst:0A:00:0F:FE:00:02,output=4</div><div class="line"></div><div class="line">ovs-ofctl -O OpenFlow13 add-flow tcp:127.0.0.1:6640 in_port=2,ip,nw_src=10.0.0.2,nw_dst=10.0.9.2,actions=mod_dl_src:0A:00:12:01:00:03,mod_dl_dst:0A:00:12:FE:00:03,output=3</div><div class="line"></div><div class="line">ovs-ofctl -O OpenFlow13 add-flow tcp:127.0.0.1:6641 in_port=3,ip,nw_src=10.0.0.2,nw_dst=10.0.9.2,actions=group=0</div><div class="line"></div><div class="line">ovs-ofctl -O OpenFlow13 add-flow tcp:127.0.0.1:6643 in_port=2,ip,nw_src=10.0.0.2,nw_dst=10.0.9.2,actions=mod_dl_src:0A:00:09:01:00:01,mod_dl_dst:0A:00:09:02:00:00,output=1</div><div class="line"></div><div class="line">ovs-ofctl -O OpenFlow13 add-flow tcp:127.0.0.1:6642 in_port=2,ip,nw_src=10.0.0.2,nw_dst=10.0.9.2,actions=mod_dl_src:0A:00:15:01:00:03,mod_dl_dst:0A:00:15:FE:00:03,output=3</div><div class="line"></div><div class="line">ovs-ofctl -O OpenFlow13 add-flow tcp:127.0.0.1:6643 in_port=3,ip,nw_src=10.0.0.2,nw_dst=10.0.9.2,actions=mod_dl_src:0A:00:09:01:00:01,mod_dl_dst:0A:00:09:02:00:00,output=1</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160801105238979" alt="这里写图片描述"></p>
<p>参考<a href="https://github.com/saeenali/openvswitch" target="_blank" rel="external">https://github.com/saeenali/openvswitch</a></p>
<p>总结：<br>这几个实验当中，个人最喜欢的是第四个tinyhttp和webbench，感觉最实用，第五个ovs感觉很综合有许多概念还是比较模糊，也花了很多时间研究。<br>在这半个月的学习中，一步一步总结步骤、截图，最重要是学会了资料搜索，获益匪浅！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yisiqiu.com/2016/07/27/CentOS-on-Mac-4-WebBench测试TinyHttpd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Izzy Qiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/profile.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Izzy Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/27/CentOS-on-Mac-4-WebBench测试TinyHttpd/" itemprop="url">#CentOS on Mac#4.WebBench测试TinyHttpd </a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-27T22:37:04+08:00">
                2016-07-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>早有听闻WebBench和TinyHttpd是工程师不得不了解的十大优秀C语言开源项目<br>出乎我意料的是，两个项目的代目都十分精简约在400行左右，而且稳定性极高，将近十年未更新</p>
<blockquote>
<p>任务：<br>1.编译运行WebBench并了解注释WebBench源代码<br>2.编译运行TinyHttpd并了解注释TinyHttpd源代码<br>3.用编译的WebBench测试编译的TinyHttpd</p>
</blockquote>
<p>那就先说WebBench咯~</p>
<p><strong>WebBench</strong><br>源码在此<br><a href="http://home.tiscali.cz/~cz210552/webbench.html" target="_blank" rel="external">http://home.tiscali.cz/~cz210552/webbench.html</a></p>
<p><strong>编译运行</strong><br>步骤如下<br>1.在网站上下载源代码<br><code>wget http://home.tiscali.cz/~cz210552/distfiles/webbench-1.5.tar.gz</code></p>
<p><img src="http://img.blog.csdn.net/20160727222008648" alt="这里写图片描述"></p>
<p>2.解压<br><code>tar  zxvf webbench-1.5.tar.gz</code><br>//tinyhttpd同理</p>
<p><img src="http://img.blog.csdn.net/20160727222044258" alt="这里写图片描述"></p>
<p>3.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd webbench-1.5</div></pre></td></tr></table></figure>
<p>4.make文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160727222105836" alt="这里写图片描述"><br>(1)<br>出现找不到ctags或gcc</p>
<blockquote>
<p>yum install ctags</p>
</blockquote>
<p><img src="http://img.blog.csdn.net/20160727222211874" alt="这里写图片描述"><br>5.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make install</div></pre></td></tr></table></figure>
<p>(2)error 1</p>
<blockquote>
<p>mkdir -m 644 -p /usr/local/man/man1</p>
</blockquote>
<p><img src="http://img.blog.csdn.net/20160727222225743" alt="这里写图片描述"><br><strong>WebBench使用</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">webbench -c 1000 -t 60 http://www.baidu.com/index.html</div></pre></td></tr></table></figure>
<p>webbench -c 并发数 -t 运行测试时间 URL</p>
<p>x可以直接输3w或者IP地址<br>通过ping获取IP地址</p>
<p><img src="http://img.blog.csdn.net/20160727222343517" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160727222420932" alt="这里写图片描述"></p>
<p>开始测试<strong>baidu服务器的抗压性能</strong><br>注意IP地址跟域名是一样的意思</p>
<p>咱们先试一下100个用户30s测试</p>
<p><img src="http://img.blog.csdn.net/20160727223111870" alt="这里写图片描述"></p>
<p>可以看出全都成功了</p>
<p>1000个用户30s测试</p>
<p><img src="http://img.blog.csdn.net/20160727223131620" alt="这里写图片描述"></p>
<p>=v=结果如图</p>
<p>100个用户60s测试<br><img src="http://img.blog.csdn.net/20160727223146120" alt="这里写图片描述"></p>
<p>10%左右的成功率。。</p>
<p>前方高能WebBench400多行的<br><strong>！！！源码分析！！！！</strong></p>
<p><strong>//socket.c</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">/* $Id: socket.c 1.1 1995/01/01 07:11:14 cthuang Exp $</div><div class="line"> *</div><div class="line"> * This module has been modified by Radim Kolar for OS/2 emx</div><div class="line"> */</div><div class="line"></div><div class="line">/***********************************************************************</div><div class="line">  module:       socket.c</div><div class="line">  program:      popclient</div><div class="line">  SCCS ID:      @(#)socket.c    1.5  4/1/94</div><div class="line">  programmer:   Virginia Tech Computing Center</div><div class="line">  compiler:     DEC RISC C compiler (Ultrix 4.1)</div><div class="line">  environment:  DEC Ultrix 4.3</div><div class="line">  description:  UNIX sockets code.</div><div class="line"> ***********************************************************************/</div><div class="line"></div><div class="line">#include &lt;sys/types.h&gt;</div><div class="line">#include &lt;sys/socket.h&gt;</div><div class="line">#include &lt;fcntl.h&gt;</div><div class="line">#include &lt;netinet/in.h&gt;</div><div class="line">#include &lt;arpa/inet.h&gt;</div><div class="line">#include &lt;netdb.h&gt;</div><div class="line">#include &lt;sys/time.h&gt;</div><div class="line">#include &lt;string.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include &lt;stdarg.h&gt;</div><div class="line">//连接类型为TCP，使用IPv4网域</div><div class="line"> //host为服务器ip，clientPort建立socket连接</div><div class="line">int Socket(const char *host, int clientPort)</div><div class="line">&#123;</div><div class="line">    int sock;</div><div class="line">    unsigned long inaddr;</div><div class="line">    struct sockaddr_in ad;</div><div class="line">    struct hostent *hp;</div><div class="line"></div><div class="line">    memset(&amp;ad, 0, sizeof(ad));</div><div class="line">    ad.sin_family = AF_INET;</div><div class="line"></div><div class="line">    inaddr = inet_addr(host);</div><div class="line">    if (inaddr != INADDR_NONE)</div><div class="line">        memcpy(&amp;ad.sin_addr, &amp;inaddr, sizeof(inaddr));</div><div class="line">    else</div><div class="line">    &#123;</div><div class="line">        hp = gethostbyname(host); //域名获取IP</div><div class="line">        if (hp == NULL)</div><div class="line">            return -1;</div><div class="line">        memcpy(&amp;ad.sin_addr, hp-&gt;h_addr, hp-&gt;h_length);</div><div class="line">    &#125;</div><div class="line">    ad.sin_port = htons(clientPort);</div><div class="line"></div><div class="line">    sock = socket(AF_INET, SOCK_STREAM, 0);</div><div class="line">    if (sock &lt; 0)</div><div class="line">        return sock;</div><div class="line">    if (connect(sock, (struct sockaddr *)&amp;ad, sizeof(ad)) &lt; 0)</div><div class="line">        return -1;  //出错返回－1</div><div class="line">    return sock;   //正常连接，返回socket连接符</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>－－－－－－－－－－－－－－－－－－－－－－－－</p>
<p><strong>//webbench.c</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * (C) Radim Kolar 1997-2004</div><div class="line"> * This is free software, see GNU Public License version 2 for</div><div class="line"> * details.</div><div class="line"> *</div><div class="line"> * Simple forking WWW Server benchmark:</div><div class="line"> *</div><div class="line"> * Usage:</div><div class="line"> *   webbench --help</div><div class="line"> *</div><div class="line"> * Return codes:</div><div class="line"> *    0 - sucess</div><div class="line"> *    1 - benchmark failed (server is not on-line)</div><div class="line"> *    2 - bad param</div><div class="line"> *    3 - internal error, fork failed</div><div class="line"> *</div><div class="line"> */</div><div class="line">#include &quot;socket.c&quot;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;sys/param.h&gt;</div><div class="line">#include &lt;rpc/types.h&gt;</div><div class="line">#include &lt;getopt.h&gt;</div><div class="line">#include &lt;strings.h&gt;</div><div class="line">#include &lt;time.h&gt;</div><div class="line">#include &lt;signal.h&gt;</div><div class="line"></div><div class="line">/* values */</div><div class="line">volatile int timerexpired=0;</div><div class="line">int speed=0;</div><div class="line">int failed=0;</div><div class="line">int bytes=0;</div><div class="line">/* globals */</div><div class="line">int http10=1; /* 0 - http/0.9, 1 - http/1.0, 2 - http/1.1 */  </div><div class="line">/* Allow: GET, HEAD, OPTIONS, TRACE */</div><div class="line">#define METHOD_GET 0</div><div class="line">#define METHOD_HEAD 1</div><div class="line">#define METHOD_OPTIONS 2</div><div class="line">#define METHOD_TRACE 3</div><div class="line">#define PROGRAM_VERSION &quot;1.5&quot;</div><div class="line">int method=METHOD_GET; //方法</div><div class="line">int clients=1;  //并发数</div><div class="line">int force=0; //等待服务器应答</div><div class="line">int force_reload=0;</div><div class="line">int proxyport=80;  //代理服务器端口</div><div class="line">char *proxyhost=NULL; //代理服务器地址</div><div class="line">int benchtime=30; //运行时间</div><div class="line">/* internal */</div><div class="line">int mypipe[2];</div><div class="line">char host[MAXHOSTNAMELEN];</div><div class="line">#define REQUEST_SIZE 2048</div><div class="line">char request[REQUEST_SIZE];</div><div class="line">//方法选择</div><div class="line">static const struct option long_options[]=</div><div class="line">&#123;</div><div class="line"> &#123;&quot;force&quot;,no_argument,&amp;force,1&#125;,</div><div class="line"> &#123;&quot;reload&quot;,no_argument,&amp;force_reload,1&#125;,</div><div class="line"> &#123;&quot;time&quot;,required_argument,NULL,&apos;t&apos;&#125;,</div><div class="line"> &#123;&quot;help&quot;,no_argument,NULL,&apos;?&apos;&#125;,</div><div class="line"> &#123;&quot;http09&quot;,no_argument,NULL,&apos;9&apos;&#125;,</div><div class="line"> &#123;&quot;http10&quot;,no_argument,NULL,&apos;1&apos;&#125;,</div><div class="line"> &#123;&quot;http11&quot;,no_argument,NULL,&apos;2&apos;&#125;,</div><div class="line"> &#123;&quot;get&quot;,no_argument,&amp;method,METHOD_GET&#125;,</div><div class="line"> &#123;&quot;head&quot;,no_argument,&amp;method,METHOD_HEAD&#125;,</div><div class="line"> &#123;&quot;options&quot;,no_argument,&amp;method,METHOD_OPTIONS&#125;,</div><div class="line"> &#123;&quot;trace&quot;,no_argument,&amp;method,METHOD_TRACE&#125;,</div><div class="line"> &#123;&quot;version&quot;,no_argument,NULL,&apos;V&apos;&#125;,</div><div class="line"> &#123;&quot;proxy&quot;,required_argument,NULL,&apos;p&apos;&#125;,</div><div class="line"> &#123;&quot;clients&quot;,required_argument,NULL,&apos;c&apos;&#125;,</div><div class="line"> &#123;NULL,0,NULL,0&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">/* prototypes */</div><div class="line">static void benchcore(const char* host,const int port, const char *request);</div><div class="line">static int bench(void);</div><div class="line">static void build_request(const char *url);</div><div class="line"></div><div class="line">static void alarm_handler(int signal)</div><div class="line">&#123;</div><div class="line">   timerexpired=1;</div><div class="line">&#125;</div><div class="line">//调用方法</div><div class="line">static void usage(void)</div><div class="line">&#123;</div><div class="line">   fprintf(stderr,</div><div class="line">&quot;webbench [option]... URL\n&quot;</div><div class="line">&quot;  -f|--force               Don&apos;t wait for reply from server.\n&quot;</div><div class="line">&quot;  -r|--reload              Send reload request - Pragma: no-cache.\n&quot;</div><div class="line">&quot;  -t|--time &lt;sec&gt;          Run benchmark for &lt;sec&gt; seconds. Default 30.\n&quot;</div><div class="line">&quot;  -p|--proxy &lt;server:port&gt; Use proxy server for request.\n&quot;</div><div class="line">&quot;  -c|--clients &lt;n&gt;         Run &lt;n&gt; HTTP clients at once. Default one.\n&quot;</div><div class="line">&quot;  -9|--http09              Use HTTP/0.9 style requests.\n&quot;</div><div class="line">&quot;  -1|--http10              Use HTTP/1.0 protocol.\n&quot;</div><div class="line">&quot;  -2|--http11              Use HTTP/1.1 protocol.\n&quot;</div><div class="line">&quot;  --get                    Use GET request method.\n&quot;</div><div class="line">&quot;  --head                   Use HEAD request method.\n&quot;</div><div class="line">&quot;  --options                Use OPTIONS request method.\n&quot;</div><div class="line">&quot;  --trace                  Use TRACE request method.\n&quot;</div><div class="line">&quot;  -?|-h|--help             This information.\n&quot;</div><div class="line">&quot;  -V|--version             Display program version.\n&quot;</div><div class="line">);</div><div class="line">&#125;;</div><div class="line">int main(int argc, char *argv[])</div><div class="line">&#123;</div><div class="line"> int opt=0;</div><div class="line"> int options_index=0;</div><div class="line"> char *tmp=NULL;</div><div class="line">//错误</div><div class="line"> if(argc==1)</div><div class="line"> &#123;</div><div class="line"> usage();</div><div class="line">          return 2;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> while((opt=getopt_long(argc,argv,&quot;912Vfrt:p:c:?h&quot;,long_options,&amp;options_index))!=EOF )</div><div class="line"> &#123;</div><div class="line">  switch(opt)</div><div class="line">  &#123; //输入参数</div><div class="line">   case  0 : break;</div><div class="line">   case &apos;f&apos;: force=1;break;</div><div class="line">   case &apos;r&apos;: force_reload=1;break;</div><div class="line">   case &apos;9&apos;: http10=0;break;</div><div class="line">   case &apos;1&apos;: http10=1;break;</div><div class="line">   case &apos;2&apos;: http10=2;break;</div><div class="line">   case &apos;V&apos;: printf(PROGRAM_VERSION&quot;\n&quot;);exit(0); //输入版本号</div><div class="line">   case &apos;t&apos;: benchtime=atoi(optarg);break;	     //命令后的参数，atoi字符转换长整型</div><div class="line">   case &apos;p&apos;:</div><div class="line">    /* proxy server parsing server:port */</div><div class="line">    tmp=strrchr(optarg,&apos;:&apos;);</div><div class="line">    proxyhost=optarg; //设定地址</div><div class="line">    if(tmp==NULL)</div><div class="line">    &#123;</div><div class="line">    break;</div><div class="line">    &#125;</div><div class="line">    if(tmp==optarg)</div><div class="line">    &#123;</div><div class="line">    fprintf(stderr,&quot;Error in option --proxy %s: Missing hostname.\n&quot;,optarg);</div><div class="line">    return 2;</div><div class="line">    &#125;</div><div class="line">    if(tmp==optarg+strlen(optarg)-1)</div><div class="line">    &#123;</div><div class="line">    fprintf(stderr,&quot;Error in option --proxy %s Port number is missing.\n&quot;,optarg);</div><div class="line">    return 2;</div><div class="line">    &#125;</div><div class="line">    *tmp=&apos;\0&apos;;</div><div class="line">    proxyport=atoi(tmp+1);break;</div><div class="line">   case &apos;:&apos;:</div><div class="line">   case &apos;h&apos;:</div><div class="line">   case &apos;?&apos;: usage();return 2;break;</div><div class="line">   case &apos;c&apos;: clients=atoi(optarg);break;</div><div class="line">  &#125;</div><div class="line"> &#125;</div><div class="line"> //optind参数下标</div><div class="line"> if(optind==argc) &#123;</div><div class="line">                      fprintf(stderr,&quot;webbench: Missing URL!\n&quot;);</div><div class="line">     usage();</div><div class="line">     return 2;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line"> if(clients==0) clients=1;</div><div class="line"> if(benchtime==0) benchtime=60;</div><div class="line"> /* Copyright */</div><div class="line"> fprintf(stderr,&quot;Webbench - Simple Web Benchmark &quot;PROGRAM_VERSION&quot;\n&quot;</div><div class="line">&quot;Copyright (c) Radim Kolar 1997-2004, GPL Open Source Software.\n&quot;</div><div class="line">);</div><div class="line">//optind为URL位置</div><div class="line"> build_request(argv[optind]);</div><div class="line"> /* print bench info */</div><div class="line"> printf(&quot;\nBenchmarking: &quot;);</div><div class="line"> switch(method)</div><div class="line"> &#123;</div><div class="line">case METHOD_GET:</div><div class="line">default:</div><div class="line">printf(&quot;GET&quot;);break;</div><div class="line">case METHOD_OPTIONS:</div><div class="line">printf(&quot;OPTIONS&quot;);break;</div><div class="line">case METHOD_HEAD:</div><div class="line">printf(&quot;HEAD&quot;);break;</div><div class="line">case METHOD_TRACE:</div><div class="line">printf(&quot;TRACE&quot;);break;</div><div class="line"> &#125;</div><div class="line"> printf(&quot; %s&quot;,argv[optind]);</div><div class="line"> switch(http10)</div><div class="line"> &#123;</div><div class="line">case 0: printf(&quot; (using HTTP/0.9)&quot;);break;</div><div class="line">case 2: printf(&quot; (using HTTP/1.1)&quot;);break;</div><div class="line"> &#125;</div><div class="line"> printf(&quot;\n&quot;);</div><div class="line"> if(clients==1) printf(&quot;1 client&quot;);</div><div class="line"> else</div><div class="line">   printf(&quot;%d clients&quot;,clients);</div><div class="line"></div><div class="line"> printf(&quot;, running %d sec&quot;, benchtime);</div><div class="line"> if(force) printf(&quot;, early socket close&quot;);</div><div class="line"> if(proxyhost!=NULL) printf(&quot;, via proxy server %s:%d&quot;,proxyhost,proxyport);</div><div class="line"> if(force_reload) printf(&quot;, forcing reload&quot;);</div><div class="line"> printf(&quot;.\n&quot;);</div><div class="line"> return bench();</div><div class="line">&#125;</div><div class="line">//创建URL请求连接</div><div class="line">void build_request(const char *url)</div><div class="line">&#123;</div><div class="line">  char tmp[10];</div><div class="line">  int i;</div><div class="line">//请求地址和连接清零</div><div class="line">  bzero(host,MAXHOSTNAMELEN);</div><div class="line">  bzero(request,REQUEST_SIZE);</div><div class="line"></div><div class="line">  if(force_reload &amp;&amp; proxyhost!=NULL &amp;&amp; http10&lt;1) http10=1;</div><div class="line">  if(method==METHOD_HEAD &amp;&amp; http10&lt;1) http10=1;</div><div class="line">  if(method==METHOD_OPTIONS &amp;&amp; http10&lt;2) http10=2;</div><div class="line">  if(method==METHOD_TRACE &amp;&amp; http10&lt;2) http10=2;</div><div class="line"></div><div class="line">  switch(method)</div><div class="line">  &#123;</div><div class="line"> default:</div><div class="line"> case METHOD_GET: strcpy(request,&quot;GET&quot;);break;</div><div class="line"> case METHOD_HEAD: strcpy(request,&quot;HEAD&quot;);break;</div><div class="line"> case METHOD_OPTIONS: strcpy(request,&quot;OPTIONS&quot;);break;</div><div class="line"> case METHOD_TRACE: strcpy(request,&quot;TRACE&quot;);break;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  strcat(request,&quot; &quot;);</div><div class="line"></div><div class="line">  if(NULL==strstr(url,&quot;://&quot;))</div><div class="line">  &#123;</div><div class="line"> fprintf(stderr, &quot;\n%s: is not a valid URL.\n&quot;,url);</div><div class="line"> exit(2);</div><div class="line">  &#125;</div><div class="line">  if(strlen(url)&gt;1500) //太长出错</div><div class="line">  &#123;</div><div class="line">         fprintf(stderr,&quot;URL is too long.\n&quot;);</div><div class="line">exit(2);</div><div class="line">  &#125;</div><div class="line">  if(proxyhost==NULL) //代理服务器为空</div><div class="line">  if (0!=strncasecmp(&quot;http://&quot;,url,7))</div><div class="line">  &#123; fprintf(stderr,&quot;\nOnly HTTP protocol is directly supported, set --proxy for others.\n&quot;);</div><div class="line">             exit(2);</div><div class="line">           &#125;</div><div class="line">  /* protocol/host delimiter */</div><div class="line">  i=strstr(url,&quot;://&quot;)-url+3; //i指向有用地址</div><div class="line">  /* printf(&quot;%d\n&quot;,i); */</div><div class="line"></div><div class="line">  if(strchr(url+i,&apos;/&apos;)==NULL) &#123;</div><div class="line">                                fprintf(stderr,&quot;\nInvalid URL syntax - hostname don&apos;t ends with &apos;/&apos;.\n&quot;);</div><div class="line">                                exit(2);</div><div class="line">                              &#125;</div><div class="line">  if(proxyhost==NULL)</div><div class="line">  &#123;</div><div class="line">   /* get port from hostname */</div><div class="line">   if(index(url+i,&apos;:&apos;)!=NULL &amp;&amp;</div><div class="line">      index(url+i,&apos;:&apos;)&lt;index(url+i,&apos;/&apos;))</div><div class="line">   &#123;</div><div class="line">  strncpy(host,url+i,strchr(url+i,&apos;:&apos;)-url-i); //取出主机地址</div><div class="line">  bzero(tmp,10);</div><div class="line">  strncpy(tmp,index(url+i,&apos;:&apos;)+1,strchr(url+i,&apos;/&apos;)-index(url+i,&apos;:&apos;)-1);</div><div class="line">  /* printf(&quot;tmp=%s\n&quot;,tmp); */</div><div class="line">  proxyport=atoi(tmp);</div><div class="line">  if(proxyport==0) proxyport=80;</div><div class="line">   &#125; else</div><div class="line">   &#123;</div><div class="line">     strncpy(host,url+i,strcspn(url+i,&quot;/&quot;));</div><div class="line">   &#125;</div><div class="line">   // printf(&quot;Host=%s\n&quot;,host);</div><div class="line">   strcat(request+strlen(request),url+i+strcspn(url+i,&quot;/&quot;));</div><div class="line">  &#125; else</div><div class="line">  &#123;</div><div class="line">   // printf(&quot;ProxyHost=%s\nProxyPort=%d\n&quot;,proxyhost,proxyport);</div><div class="line">   strcat(request,url);</div><div class="line">  &#125;</div><div class="line">  if(http10==1)</div><div class="line"> strcat(request,&quot; HTTP/1.0&quot;);</div><div class="line">  else if (http10==2)</div><div class="line"> strcat(request,&quot; HTTP/1.1&quot;);</div><div class="line">  strcat(request,&quot;\r\n&quot;);</div><div class="line">  if(http10&gt;0)</div><div class="line"> strcat(request,&quot;User-Agent: WebBench &quot;PROGRAM_VERSION&quot;\r\n&quot;);</div><div class="line">  if(proxyhost==NULL &amp;&amp; http10&gt;0)</div><div class="line">  &#123;</div><div class="line"> strcat(request,&quot;Host: &quot;);</div><div class="line"> strcat(request,host);</div><div class="line"> strcat(request,&quot;\r\n&quot;);</div><div class="line">  &#125;</div><div class="line">  if(force_reload &amp;&amp; proxyhost!=NULL)</div><div class="line">  &#123;</div><div class="line"> strcat(request,&quot;Pragma: no-cache\r\n&quot;);</div><div class="line">  &#125;</div><div class="line">  if(http10&gt;1)</div><div class="line"> strcat(request,&quot;Connection: close\r\n&quot;);</div><div class="line">  /* add empty line at end */</div><div class="line">  if(http10&gt;0) strcat(request,&quot;\r\n&quot;);</div><div class="line">  // printf(&quot;Req=%s\n&quot;,request);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* vraci system rc error kod */</div><div class="line">//创建管道和子进程，进行测试</div><div class="line">static int bench(void)</div><div class="line">&#123;</div><div class="line">  int i,j,k;</div><div class="line">  pid_t pid=0;</div><div class="line">  FILE *f;</div><div class="line"></div><div class="line">  /* check avaibility of target server */</div><div class="line">  i=Socket(proxyhost==NULL?host:proxyhost,proxyport);</div><div class="line">  if(i&lt;0) &#123;</div><div class="line">  fprintf(stderr,&quot;\nConnect to server failed. Aborting benchmark.\n&quot;);</div><div class="line">           return 1;</div><div class="line">         &#125;</div><div class="line">  close(i);</div><div class="line">  /* create pipe */</div><div class="line">  if(pipe(mypipe))</div><div class="line">  &#123;</div><div class="line"> perror(&quot;pipe failed.&quot;);</div><div class="line"> return 3;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /* not needed, since we have alarm() in childrens */</div><div class="line">  /* wait 4 next system clock tick */</div><div class="line">  /*</div><div class="line">  cas=time(NULL);</div><div class="line">  while(time(NULL)==cas)</div><div class="line">        sched_yield();</div><div class="line">  */</div><div class="line"></div><div class="line">  /* fork childs */</div><div class="line">  for(i=0;i&lt;clients;i++)</div><div class="line">  &#123;</div><div class="line">  pid=fork();</div><div class="line">  if(pid &lt;= (pid_t) 0)</div><div class="line">  &#123;</div><div class="line">  /* child process or error*/</div><div class="line">          sleep(1); /* make childs faster */</div><div class="line">  break;</div><div class="line">  &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if( pid&lt; (pid_t) 0)</div><div class="line">  &#123;</div><div class="line">          fprintf(stderr,&quot;problems forking worker no. %d\n&quot;,i);</div><div class="line"> perror(&quot;fork failed.&quot;);</div><div class="line"> return 3;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if(pid== (pid_t) 0)</div><div class="line">  &#123;</div><div class="line">    /* I am a child */</div><div class="line">    if(proxyhost==NULL)</div><div class="line">      benchcore(host,proxyport,request);</div><div class="line">         else</div><div class="line">      benchcore(proxyhost,proxyport,request);</div><div class="line"></div><div class="line">         /* write results to pipe */</div><div class="line">f=fdopen(mypipe[1],&quot;w&quot;);</div><div class="line">if(f==NULL)</div><div class="line">&#123;</div><div class="line">perror(&quot;open pipe for writing failed.&quot;);</div><div class="line">return 3;</div><div class="line">&#125;</div><div class="line">/* fprintf(stderr,&quot;Child - %d %d\n&quot;,speed,failed); */</div><div class="line">fprintf(f,&quot;%d %d %d\n&quot;,speed,failed,bytes); //把每个子进程放到管道</div><div class="line">fclose(f);</div><div class="line">return 0;</div><div class="line">  &#125; else</div><div class="line">  &#123;</div><div class="line"> f=fdopen(mypipe[0],&quot;r&quot;);</div><div class="line"> if(f==NULL)</div><div class="line"> &#123;</div><div class="line"> perror(&quot;open pipe for reading failed.&quot;);</div><div class="line"> return 3;</div><div class="line"> &#125;</div><div class="line"> setvbuf(f,NULL,_IONBF,0);</div><div class="line"> speed=0;</div><div class="line">          failed=0;</div><div class="line">          bytes=0;</div><div class="line"></div><div class="line"> while(1)</div><div class="line">//父进程读取管道数据，并做加法</div><div class="line"> &#123;</div><div class="line"> pid=fscanf(f,&quot;%d %d %d&quot;,&amp;i,&amp;j,&amp;k);</div><div class="line"> if(pid&lt;2)</div><div class="line">                  &#123;</div><div class="line">                       fprintf(stderr,&quot;Some of our childrens died.\n&quot;);</div><div class="line">                       break;</div><div class="line">                  &#125;</div><div class="line"> speed+=i;</div><div class="line"> failed+=j;</div><div class="line"> bytes+=k;</div><div class="line"> /* fprintf(stderr,&quot;*Knock* %d %d read=%d\n&quot;,speed,failed,pid); */</div><div class="line"> if(--clients==0) break;</div><div class="line"> &#125;</div><div class="line"> fclose(f);</div><div class="line">//输出结果</div><div class="line">  printf(&quot;\nSpeed=%d pages/min, %d bytes/sec.\nRequests: %d susceed, %d failed.\n&quot;,</div><div class="line"> (int)((speed+failed)/(benchtime/60.0f)),</div><div class="line"> (int)(bytes/(float)benchtime),</div><div class="line"> speed,</div><div class="line"> failed);</div><div class="line">  &#125;</div><div class="line">  return i;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void benchcore(const char *host,const int port,const char *req)</div><div class="line">&#123;</div><div class="line"> int rlen;</div><div class="line"> char buf[1500];</div><div class="line"> int s,i;</div><div class="line"> struct sigaction sa;</div><div class="line"></div><div class="line"> /* setup alarm signal handler */</div><div class="line"> sa.sa_handler=alarm_handler; //定时器方法</div><div class="line"> sa.sa_flags=0;</div><div class="line"> if(sigaction(SIGALRM,&amp;sa,NULL))</div><div class="line">    exit(3);</div><div class="line"> alarm(benchtime);</div><div class="line"></div><div class="line"> rlen=strlen(req);</div><div class="line"> nexttry:while(1)</div><div class="line"> &#123;</div><div class="line">    if(timer expired)//超时</div><div class="line">    &#123;</div><div class="line">       if(failed&gt;0)</div><div class="line">       &#123;</div><div class="line">          /* fprintf(stderr,&quot;Correcting failed by signal\n&quot;); */</div><div class="line">          failed--;</div><div class="line">       &#125;</div><div class="line">       return;</div><div class="line">    &#125;</div><div class="line">    s=Socket(host,port);      //创建链接                    </div><div class="line">    if(s&lt;0) &#123; failed++;continue;&#125; //连接失败</div><div class="line">    if(rlen!=write(s,req,rlen)) &#123;failed++;close(s);continue;&#125;</div><div class="line">    if(http10==0)</div><div class="line">   if(shutdown(s,1)) &#123; failed++;close(s);continue;&#125;//发送失败</div><div class="line">    if(force==0) //读取http请求数据</div><div class="line">    &#123;</div><div class="line">            /* read all available data from socket */</div><div class="line">   while(1)</div><div class="line">   &#123;</div><div class="line">              if(timerexpired) break;</div><div class="line">     i=read(s,buf,1500);</div><div class="line">              /* fprintf(stderr,&quot;%d\n&quot;,i); */</div><div class="line">     if(i&lt;0)</div><div class="line">              &#123;</div><div class="line">                 failed++;</div><div class="line">                 close(s);</div><div class="line">                 goto nexttry;</div><div class="line">              &#125;</div><div class="line">      else</div><div class="line">      if(i==0) break;</div><div class="line">      else</div><div class="line">      bytes+=i;</div><div class="line">   &#125;</div><div class="line">    &#125;</div><div class="line">    if(close(s)) &#123;failed++;continue;&#125;</div><div class="line">    speed++; //测试成功</div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>参考<br><a href="http://www.cnblogs.com/xuning/p/3888699.html" target="_blank" rel="external">http://www.cnblogs.com/xuning/p/3888699.html</a></p>
<p>接下来说一说TinyHttpd~</p>
<p><strong>TinyHttpd</strong><br><a href="https://sourceforge.net/projects/tinyhttpd/files/latest/download" target="_blank" rel="external">https://sourceforge.net/projects/tinyhttpd/files/latest/download</a></p>
<p>源码在此  <em>tinyhttpd-0.1.0.tar.gz</em></p>
<p><strong>编译运行</strong><br>步骤如下<br>1.在网站上下载源代码</p>
<p><code>wget http://jaist.dl.sourceforge.net/project/tinyhttpd/tinyhttpd%20source/tinyhttpd%200.1.0/tinyhttpd-0.1.0.tar.gz</code></p>
<p><img src="http://img.blog.csdn.net/20160727223156889" alt="这里写图片描述"></p>
<p>2.解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar  zxvf tinyhttpd-0.1.0.tar.gz</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160730210123873" alt="这里写图片描述"></p>
<p>3.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd tinyhttpd-0.1.0</div></pre></td></tr></table></figure></p>
<p>4.make文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make</div></pre></td></tr></table></figure>
<p><strong>高能出现错误！</strong></p>
<p><img src="http://img.blog.csdn.net/20160730210257235" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160730210313016" alt="这里写图片描述"></p>
<p><strong>原因分析！</strong></p>
<p>TinyHttpd本来是在solaris上实现的，在socket和pthread的实现上和一般的Linux不一样。httpd.c开始的英文注释做出了对程序修改的详细指引</p>
<p><strong>故（1）修改httpd.c</strong>根据开头注释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div></pre></td><td class="code"><pre><div class="line">httpd.c</div><div class="line"></div><div class="line">/* J. David&apos;s webserver */</div><div class="line">/* This is a simple webserver.</div><div class="line"> * Created November 1999 by J. David Blackstone.</div><div class="line"> * CSE 4344 (Network concepts), Prof. Zeigler</div><div class="line"> * University of Texas at Arlington</div><div class="line"> */</div><div class="line">/* This program compiles for Sparc Solaris 2.6.</div><div class="line"> * To compile for Linux:</div><div class="line"> *  1) Comment out the #include &lt;pthread.h&gt; line.</div><div class="line"> *  2) Comment out the line that defines the variable newthread.</div><div class="line"> *  3) Comment out the two lines that run pthread_create().</div><div class="line"> *  4) Uncomment the line that runs accept_request().</div><div class="line"> *  5) Remove -lsocket from the Makefile.</div><div class="line"> */</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;sys/socket.h&gt;</div><div class="line">#include &lt;sys/types.h&gt;</div><div class="line">#include &lt;netinet/in.h&gt;</div><div class="line">#include &lt;arpa/inet.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;ctype.h&gt;</div><div class="line">#include &lt;strings.h&gt;</div><div class="line">#include &lt;string.h&gt;</div><div class="line">#include &lt;sys/stat.h&gt;</div><div class="line">#include &lt;pthread.h&gt;</div><div class="line">#include &lt;sys/wait.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line"></div><div class="line">#define ISspace(x) isspace((int)(x))</div><div class="line"></div><div class="line">#define SERVER_STRING &quot;Server: jdbhttpd/0.1.0\r\n&quot;</div><div class="line"></div><div class="line">void *accept_request(void *);</div><div class="line">void bad_request(int);</div><div class="line">void cat(int, FILE *);</div><div class="line">void cannot_execute(int);</div><div class="line">void error_die(const char *);</div><div class="line">void execute_cgi(int, const char *, const char *, const char *);</div><div class="line">int get_line(int, char *, int);</div><div class="line">void headers(int, const char *);</div><div class="line">void not_found(int);</div><div class="line">void serve_file(int, const char *);</div><div class="line">int startup(u_short *);</div><div class="line">void unimplemented(int);</div><div class="line"></div><div class="line">/**********************************************************************/</div><div class="line">/* A request has caused a call to accept() on the server port to</div><div class="line"> * return.  Process the request appropriately.</div><div class="line"> * Parameters: the socket connected to the client */</div><div class="line">/**********************************************************************/</div><div class="line">void *accept_request(void * tclient)</div><div class="line">&#123;</div><div class="line"> int client = *(int *)tclient;</div><div class="line"> char buf[1024];</div><div class="line"> int numchars;</div><div class="line"> char method[255];</div><div class="line"> char url[255];</div><div class="line"> char path[512];</div><div class="line"> size_t i, j;</div><div class="line"> struct stat st;</div><div class="line"> int cgi = 0;      /* becomes true if server decides this is a CGI</div><div class="line">                    * program */</div><div class="line"> char *query_string = NULL;</div><div class="line">//得到请求第一行</div><div class="line"> numchars = get_line(client, buf, sizeof(buf));</div><div class="line"> i = 0; j = 0;</div><div class="line">//客户端请求方法存到数组</div><div class="line"> while (!ISspace(buf[j]) &amp;&amp; (i &lt; sizeof(method) - 1))</div><div class="line"> &#123;</div><div class="line">  method[i] = buf[j];</div><div class="line">  i++; j++;</div><div class="line"> &#125;</div><div class="line"> method[i] = &apos;\0&apos;;</div><div class="line"></div><div class="line"> if (strcasecmp(method, &quot;GET&quot;) &amp;&amp; strcasecmp(method, &quot;POST&quot;))</div><div class="line"> &#123;</div><div class="line">  unimplemented(client);</div><div class="line">  return NULL;</div><div class="line"> &#125;//出错</div><div class="line">//post开启cgi</div><div class="line"> if (strcasecmp(method, &quot;POST&quot;) == 0)</div><div class="line">  cgi = 1;</div><div class="line">//读取url地址</div><div class="line"> i = 0;</div><div class="line"> while (ISspace(buf[j]) &amp;&amp; (j &lt; sizeof(buf)))</div><div class="line">  j++;</div><div class="line"> while (!ISspace(buf[j]) &amp;&amp; (i &lt; sizeof(url) - 1) &amp;&amp; (j &lt; sizeof(buf)))</div><div class="line"> &#123;</div><div class="line">  url[i] = buf[j];</div><div class="line">  i++; j++;</div><div class="line"> &#125;</div><div class="line"> url[i] = &apos;\0&apos;;</div><div class="line"></div><div class="line"> if (strcasecmp(method, &quot;GET&quot;) == 0)</div><div class="line"> &#123;//待处理请求为url</div><div class="line">  query_string = url;</div><div class="line">  while ((*query_string != &apos;?&apos;) &amp;&amp; (*query_string != &apos;\0&apos;))</div><div class="line">   query_string++;</div><div class="line">  if (*query_string == &apos;?&apos;)</div><div class="line">  &#123;</div><div class="line">   cgi = 1;</div><div class="line">   *query_string = &apos;\0&apos;;</div><div class="line">   query_string++;</div><div class="line">  &#125;</div><div class="line"> &#125;</div><div class="line">//格式化url到path数组</div><div class="line"> sprintf(path, &quot;htdocs%s&quot;, url);</div><div class="line"> if (path[strlen(path) - 1] == &apos;/&apos;)</div><div class="line">  strcat(path, &quot;index.html”); //默认</div><div class="line"> if (stat(path, &amp;st) == -1) &#123; //路径找文件</div><div class="line">  while ((numchars &gt; 0) &amp;&amp; strcmp(&quot;\n&quot;, buf))  /* read &amp; discard headers */</div><div class="line">   numchars = get_line(client, buf, sizeof(buf));</div><div class="line">  not_found(client); //找不到</div><div class="line"> &#125;</div><div class="line"> else</div><div class="line"> &#123;//目录 默认index</div><div class="line">  if ((st.st_mode &amp; S_IFMT) == S_IFDIR)</div><div class="line">   strcat(path, &quot;/index.html&quot;);</div><div class="line">  if ((st.st_mode &amp; S_IXUSR) ||</div><div class="line">      (st.st_mode &amp; S_IXGRP) ||</div><div class="line">      (st.st_mode &amp; S_IXOTH)    )</div><div class="line">   cgi = 1;</div><div class="line">  if (!cgi) //非cgi，返回服务器文件</div><div class="line">   serve_file(client, path);</div><div class="line">  else</div><div class="line">   execute_cgi(client, path, method, query_string);</div><div class="line"> &#125;</div><div class="line">//断开</div><div class="line"> close(client);</div><div class="line"> return NULL;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**********************************************************************/</div><div class="line">/* Inform the client that a request it has made has a problem.</div><div class="line"> * Parameters: client socket */</div><div class="line">/**********************************************************************/</div><div class="line">void bad_request(int client)</div><div class="line">&#123;</div><div class="line"> char buf[1024];</div><div class="line">//错误请求</div><div class="line"> sprintf(buf, &quot;HTTP/1.0 400 BAD REQUEST\r\n&quot;);</div><div class="line"> send(client, buf, sizeof(buf), 0);</div><div class="line"> sprintf(buf, &quot;Content-type: text/html\r\n&quot;);</div><div class="line"> send(client, buf, sizeof(buf), 0);</div><div class="line"> sprintf(buf, &quot;\r\n&quot;);</div><div class="line"> send(client, buf, sizeof(buf), 0);</div><div class="line"> sprintf(buf, &quot;&lt;P&gt;Your browser sent a bad request, &quot;);</div><div class="line"> send(client, buf, sizeof(buf), 0);</div><div class="line"> sprintf(buf, &quot;such as a POST without a Content-Length.\r\n&quot;);</div><div class="line"> send(client, buf, sizeof(buf), 0);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**********************************************************************/</div><div class="line">/* Put the entire contents of a file out on a socket.  This function</div><div class="line"> * is named after the UNIX &quot;cat&quot; command, because it might have been</div><div class="line"> * easier just to do something like pipe, fork, and exec(&quot;cat&quot;).</div><div class="line"> * Parameters: the client socket descriptor</div><div class="line"> *             FILE pointer for the file to cat */</div><div class="line">/**********************************************************************/</div><div class="line">void cat(int client, FILE *resource)</div><div class="line">&#123;</div><div class="line"> char buf[1024];</div><div class="line">//读数据到socket</div><div class="line"> fgets(buf, sizeof(buf), resource);</div><div class="line"> while (!feof(resource))</div><div class="line"> &#123;</div><div class="line">  send(client, buf, strlen(buf), 0);</div><div class="line">  fgets(buf, sizeof(buf), resource);</div><div class="line"> &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**********************************************************************/</div><div class="line">/* Inform the client that a CGI script could not be executed.</div><div class="line"> * Parameter: the client socket descriptor. */</div><div class="line">/**********************************************************************/</div><div class="line">void cannot_execute(int client)</div><div class="line">&#123;</div><div class="line"> char buf[1024];</div><div class="line">//无法执行</div><div class="line"> sprintf(buf, &quot;HTTP/1.0 500 Internal Server Error\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;Content-type: text/html\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;&lt;P&gt;Error prohibited CGI execution.\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**********************************************************************/</div><div class="line">/* Print out an error message with perror() (for system errors; based</div><div class="line"> * on value of errno, which indicates system call errors) and exit the</div><div class="line"> * program indicating an error. */</div><div class="line">/**********************************************************************/</div><div class="line">void error_die(const char *sc)</div><div class="line">&#123;</div><div class="line"> perror(sc);</div><div class="line"> exit(1);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**********************************************************************/</div><div class="line">/* Execute a CGI script.  Will need to set environment variables as</div><div class="line"> * appropriate.</div><div class="line"> * Parameters: client socket descriptor</div><div class="line"> *             path to the CGI script */</div><div class="line">/**********************************************************************/</div><div class="line">void execute_cgi(int client, const char *path,</div><div class="line">                 const char *method, const char *query_string)</div><div class="line">&#123;</div><div class="line"> char buf[1024];</div><div class="line"> int cgi_output[2];</div><div class="line"> int cgi_input[2];</div><div class="line"> pid_t pid;</div><div class="line"> int status;</div><div class="line"> int i;</div><div class="line"> char c;</div><div class="line"> int numchars = 1;</div><div class="line"> int content_length = -1;</div><div class="line">//所有http首部读取丢弃</div><div class="line"> buf[0] = &apos;A&apos;; buf[1] = &apos;\0&apos;;</div><div class="line"> if (strcasecmp(method, &quot;GET&quot;) == 0)</div><div class="line">  while ((numchars &gt; 0) &amp;&amp; strcmp(&quot;\n&quot;, buf))  /* read &amp; discard headers */</div><div class="line">   numchars = get_line(client, buf, sizeof(buf));</div><div class="line"> else    /* POST */</div><div class="line"> &#123;//在post的http请求中找出cotent_length</div><div class="line">  numchars = get_line(client, buf, sizeof(buf));</div><div class="line">  while ((numchars &gt; 0) &amp;&amp; strcmp(&quot;\n&quot;, buf))</div><div class="line">  &#123;</div><div class="line">   buf[15] = &apos;\0&apos;;</div><div class="line">   if (strcasecmp(buf, &quot;Content-Length:&quot;) == 0)</div><div class="line">    content_length = atoi(&amp;(buf[16]));</div><div class="line">   numchars = get_line(client, buf, sizeof(buf));</div><div class="line">  &#125;//没找到</div><div class="line">  if (content_length == -1) &#123;</div><div class="line">   bad_request(client);</div><div class="line">   return;</div><div class="line">  &#125;</div><div class="line"> &#125;</div><div class="line">//http状态码200</div><div class="line"> sprintf(buf, &quot;HTTP/1.0 200 OK\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line">//建立管道，错误</div><div class="line"> if (pipe(cgi_output) &lt; 0) &#123;</div><div class="line">  cannot_execute(client);</div><div class="line">  return;</div><div class="line"> &#125;</div><div class="line"> if (pipe(cgi_input) &lt; 0) &#123;</div><div class="line">  cannot_execute(client);</div><div class="line">  return;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> if ( (pid = fork()) &lt; 0 ) &#123;</div><div class="line">  cannot_execute(client);</div><div class="line">  return;</div><div class="line"> &#125;</div><div class="line"> if (pid == 0)  /* child: CGI script */</div><div class="line"> &#123;</div><div class="line">  char meth_env[255];</div><div class="line">  char query_env[255];</div><div class="line">  char length_env[255];</div><div class="line">//把stdout重定向到写入端</div><div class="line">  dup2(cgi_output[1], 1);</div><div class="line">//stdin同理</div><div class="line">  dup2(cgi_input[0], 0);</div><div class="line">  close(cgi_output[0]);</div><div class="line">  close(cgi_input[1]);</div><div class="line">//设置环境变量</div><div class="line">  sprintf(meth_env, &quot;REQUEST_METHOD=%s&quot;, method);</div><div class="line">  putenv(meth_env);</div><div class="line">  if (strcasecmp(method, &quot;GET&quot;) == 0) &#123;</div><div class="line">//设置环境变量</div><div class="line">   sprintf(query_env, &quot;QUERY_STRING=%s&quot;, query_string);</div><div class="line">   putenv(query_env);</div><div class="line">  &#125;</div><div class="line">  else &#123;   /* POST */</div><div class="line">   sprintf(length_env, &quot;CONTENT_LENGTH=%d&quot;, content_length);</div><div class="line">   putenv(length_env);</div><div class="line">  &#125;</div><div class="line">//运行cgi程序</div><div class="line">  execl(path, path, NULL);</div><div class="line">  exit(0);</div><div class="line"> &#125; else &#123;    /* parent */</div><div class="line">  close(cgi_output[1]);</div><div class="line">  close(cgi_input[0]);</div><div class="line">  if (strcasecmp(method, &quot;POST&quot;) == 0)</div><div class="line">//接收post数据</div><div class="line">   for (i = 0; i &lt; content_length; i++) &#123;</div><div class="line">    recv(client, &amp;c, 1, 0);</div><div class="line">//把post数据写入</div><div class="line">    write(cgi_input[1], &amp;c, 1);</div><div class="line">   &#125;//读取管道输出到客户端</div><div class="line">  while (read(cgi_output[0], &amp;c, 1) &gt; 0)</div><div class="line">   send(client, &amp;c, 1, 0);</div><div class="line"></div><div class="line">  close(cgi_output[0]);</div><div class="line">  close(cgi_input[1]);</div><div class="line">//等待子程序</div><div class="line">  waitpid(pid, &amp;status, 0);</div><div class="line"> &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**********************************************************************/</div><div class="line">/* Get a line from a socket, whether the line ends in a newline,</div><div class="line"> * carriage return, or a CRLF combination.  Terminates the string read</div><div class="line"> * with a null character.  If no newline indicator is found before the</div><div class="line"> * end of the buffer, the string is terminated with a null.  If any of</div><div class="line"> * the above three line terminators is read, the last character of the</div><div class="line"> * string will be a linefeed and the string will be terminated with a</div><div class="line"> * null character.</div><div class="line"> * Parameters: the socket descriptor</div><div class="line"> *             the buffer to save the data in</div><div class="line"> *             the size of the buffer</div><div class="line"> * Returns: the number of bytes stored (excluding null) */</div><div class="line">/**********************************************************************/</div><div class="line">int get_line(int sock, char *buf, int size)</div><div class="line">&#123;</div><div class="line"> int i = 0;</div><div class="line"> char c = &apos;\0&apos;;</div><div class="line"> int n;</div><div class="line">//标准化buf数组</div><div class="line"> while ((i &lt; size - 1) &amp;&amp; (c != &apos;\n&apos;))</div><div class="line"> &#123;</div><div class="line">  n = recv(sock, &amp;c, 1, 0);</div><div class="line">  /* DEBUG printf(&quot;%02X\n&quot;, c); */</div><div class="line">  if (n &gt; 0)</div><div class="line">  &#123;//继续接受</div><div class="line">   if (c == &apos;\r&apos;)</div><div class="line">   &#123;//接收窗口不划动</div><div class="line">    n = recv(sock, &amp;c, 1, MSG_PEEK);</div><div class="line">    /* DEBUG printf(&quot;%02X\n&quot;, c); */</div><div class="line">    if ((n &gt; 0) &amp;&amp; (c == &apos;\n&apos;))</div><div class="line">     recv(sock, &amp;c, 1, 0);//吸收换行符</div><div class="line">    else</div><div class="line">     c = &apos;\n&apos;;</div><div class="line">   &#125;</div><div class="line">   buf[i] = c;</div><div class="line">   i++;</div><div class="line">  &#125;</div><div class="line">  else</div><div class="line">   c = &apos;\n&apos;;</div><div class="line"> &#125;</div><div class="line"> buf[i] = &apos;\0&apos;;</div><div class="line"></div><div class="line"> return(i);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**********************************************************************/</div><div class="line">/* Return the informational HTTP headers about a file. */</div><div class="line">/* Parameters: the socket to print the headers on</div><div class="line"> *             the name of the file */</div><div class="line">/**********************************************************************/</div><div class="line">void headers(int client, const char *filename)</div><div class="line">&#123;//正常http首部</div><div class="line"> char buf[1024];</div><div class="line"> (void)filename;  /* could use filename to determine file type */</div><div class="line"></div><div class="line"> strcpy(buf, &quot;HTTP/1.0 200 OK\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line">//服务器信息</div><div class="line"> strcpy(buf, SERVER_STRING);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;Content-Type: text/html\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> strcpy(buf, &quot;\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**********************************************************************/</div><div class="line">/* Give a client a 404 not found status message. */</div><div class="line">/**********************************************************************/</div><div class="line">void not_found(int client)</div><div class="line">&#123;</div><div class="line"> char buf[1024];</div><div class="line"></div><div class="line"> sprintf(buf, &quot;HTTP/1.0 404 NOT FOUND\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, SERVER_STRING);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;Content-Type: text/html\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;&lt;HTML&gt;&lt;TITLE&gt;Not Found&lt;/TITLE&gt;\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;&lt;BODY&gt;&lt;P&gt;The server could not fulfill\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;your request because the resource specified\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;is unavailable or nonexistent.\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;&lt;/BODY&gt;&lt;/HTML&gt;\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**********************************************************************/</div><div class="line">/* Send a regular file to the client.  Use headers, and report</div><div class="line"> * errors to client if they occur.</div><div class="line"> * Parameters: a pointer to a file structure produced from the socket</div><div class="line"> *              file descriptor</div><div class="line"> *             the name of the file to serve */</div><div class="line">/**********************************************************************/</div><div class="line">void serve_file(int client, const char *filename)</div><div class="line">&#123;</div><div class="line"> FILE *resource = NULL;</div><div class="line"> int numchars = 1;</div><div class="line"> char buf[1024];</div><div class="line">//读取丢弃header</div><div class="line"> buf[0] = &apos;A&apos;; buf[1] = &apos;\0&apos;;</div><div class="line"> while ((numchars &gt; 0) &amp;&amp; strcmp(&quot;\n&quot;, buf))  /* read &amp; discard headers */</div><div class="line">  numchars = get_line(client, buf, sizeof(buf));</div><div class="line">//打开文件</div><div class="line"> resource = fopen(filename, &quot;r&quot;);</div><div class="line"> if (resource == NULL)</div><div class="line">  not_found(client);</div><div class="line"> else</div><div class="line"> &#123;//写首部，复制文件</div><div class="line">  headers(client, filename);</div><div class="line">  cat(client, resource);</div><div class="line"> &#125;</div><div class="line"> fclose(resource);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**********************************************************************/</div><div class="line">/* This function starts the process of listening for web connections</div><div class="line"> * on a specified port.  If the port is 0, then dynamically allocate a</div><div class="line"> * port and modify the original port variable to reflect the actual</div><div class="line"> * port.</div><div class="line"> * Parameters: pointer to variable containing the port to connect on</div><div class="line"> * Returns: the socket */</div><div class="line">/**********************************************************************/</div><div class="line">int startup(u_short *port)</div><div class="line">&#123;</div><div class="line"> int httpd = 0;</div><div class="line"> struct sockaddr_in name;</div><div class="line">//建立socket</div><div class="line"> httpd = socket(PF_INET, SOCK_STREAM, 0);</div><div class="line"> if (httpd == -1)</div><div class="line">  error_die(&quot;socket&quot;);</div><div class="line"> memset(&amp;name, 0, sizeof(name));</div><div class="line"> name.sin_family = AF_INET;</div><div class="line"> name.sin_port = htons(*port);</div><div class="line"> name.sin_addr.s_addr = htonl(INADDR_ANY);</div><div class="line"> if (bind(httpd, (struct sockaddr *)&amp;name, sizeof(name)) &lt; 0)</div><div class="line">  error_die(&quot;bind”);</div><div class="line">//动态随机分配</div><div class="line"> if (*port == 0)  /* if dynamically allocating a port */</div><div class="line"> &#123;</div><div class="line">  socklen_t namelen = sizeof(name);</div><div class="line">  if (getsockname(httpd, (struct sockaddr *)&amp;name, &amp;namelen) == -1)</div><div class="line">   error_die(&quot;getsockname&quot;);</div><div class="line">  *port = ntohs(name.sin_port);</div><div class="line"> &#125;</div><div class="line">//开始监听</div><div class="line"> if (listen(httpd, 5) &lt; 0)</div><div class="line">  error_die(&quot;listen&quot;);</div><div class="line"> return(httpd);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**********************************************************************/</div><div class="line">/* Inform the client that the requested web method has not been</div><div class="line"> * implemented.</div><div class="line"> * Parameter: the client socket */</div><div class="line">/**********************************************************************/</div><div class="line">void unimplemented(int client)</div><div class="line">&#123;//method不被支持</div><div class="line"> char buf[1024];</div><div class="line"></div><div class="line"> sprintf(buf, &quot;HTTP/1.0 501 Method Not Implemented\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, SERVER_STRING);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;Content-Type: text/html\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Method Not Implemented\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;&lt;/TITLE&gt;&lt;/HEAD&gt;\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;&lt;BODY&gt;&lt;P&gt;HTTP request method not supported.\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;&lt;/BODY&gt;&lt;/HTML&gt;\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**********************************************************************/</div><div class="line"></div><div class="line">int main(void)</div><div class="line">&#123;</div><div class="line"> int server_sock = -1;</div><div class="line"> u_short port = 0;</div><div class="line"> int client_sock = -1;</div><div class="line"> struct sockaddr_in client_name;</div><div class="line"> socklen_t client_name_len = sizeof(client_name);</div><div class="line"> pthread_t newthread;</div><div class="line">//建立httpd服务</div><div class="line"> server_sock = startup(&amp;port);</div><div class="line"> printf(&quot;httpd running on port %d\n&quot;, port);</div><div class="line"></div><div class="line"> while (1)</div><div class="line"> &#123;//收到客户端链接请求</div><div class="line">  client_sock = accept(server_sock,</div><div class="line">                       (struct sockaddr *)&amp;client_name,</div><div class="line">                       &amp;client_name_len);</div><div class="line">  if (client_sock == -1)</div><div class="line">   error_die(&quot;accept&quot;);</div><div class="line"> /* accept_request(client_sock); */</div><div class="line"> if (pthread_create(&amp;newthread , NULL, accept_request, (void *)&amp;client_sock) != 0)</div><div class="line">   perror(&quot;pthread_create&quot;);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> close(server_sock);</div><div class="line"></div><div class="line"> return(0);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>(2)在makefile文件</strong>中改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc -W -Wall -o httpd httpd.c -lpthread</div></pre></td></tr></table></figure>
<p>make完结果</p>
<p><img src="http://img.blog.csdn.net/20160730211549112" alt="这里写图片描述"></p>
<p><strong>TinyHttpd使用</strong><br>1.运行应用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./httpd</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160730212735910" alt="这里写图片描述"></p>
<p>得到端口号为52870</p>
<p>2.在浏览器firefox中输入地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost:52870</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160730212834364" alt="这里写图片描述"></p>
<p><strong>TinyHttpd源码分析</strong></p>
<p>1.函数功能如下</p>
<pre><code>accept_request:  处理从套接字上监听到的一个 HTTP 请求，在这里可以很大一部分地体现服务器处理请求流程。

bad_request: 返回给客户端这是个错误请求，HTTP 状态吗 400 BAD REQUEST.

cat: 读取服务器上某个文件写到 socket 套接字。

cannot_execute: 主要处理发生在执行 cgi 程序时出现的错误。

error_die: 把错误信息写到 perror 并退出。

execute_cgi: 运行 cgi 程序的处理，也是个主要函数。

get_line: 读取套接字的一行，把回车换行等情况都统一为换行符结束。

headers: 把 HTTP 响应的头部写到套接字。

not_found: 主要处理找不到请求的文件时的情况。

sever_file: 调用 cat 把服务器文件返回给浏览器。

startup: 初始化 httpd 服务，包括建立套接字，绑定端口，进行监听等。

unimplemented: 返回给浏览器表明收到的 HTTP 请求所用的 method 不被支持。
</code></pre><p>2.注释详细如上</p>
<p><strong>[综合]WebBench测试TinyHttpd</strong><br>基本如上<br>1.用TinyHttpd小型web服务器<br><img src="http://img.blog.csdn.net/20160730213630744" alt="这里写图片描述"></p>
<p>2.用WebBench对地址进行测试<br><img src="http://img.blog.csdn.net/20160730213753057" alt="这里写图片描述"></p>
<p>出现错误</p>
<blockquote>
<p>全部failed且TinyHttpd自动断开</p>
</blockquote>
<p>开始以为并发数的问题，减小后并未改善</p>
<p><img src="http://img.blog.csdn.net/20160730214014480" alt="这里写图片描述"></p>
<p>网上查阅资料后</p>
<p><strong>解决方法</strong></p>
<p>（1）原因</p>
<blockquote>
<p>因为WebBench在一次访问完之后就断掉了，但是TinyHttpd要分次把一个网页的内容发送给WebBench，所以第一次发的时候是成功的，第二次就失败了。而且TinyHttpd在send的时候没有异常判断和处理，所以程序卡死</p>
</blockquote>
<p>（2）解决<br><strong>httpd.c的unimplemented中将后面的14行代码发送注释掉</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">void unimplemented(int client)</div><div class="line">&#123;</div><div class="line"> char buf[1024];</div><div class="line"></div><div class="line"> sprintf(buf, &quot;HTTP/1.0 501 Method Not Implemented\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> /*sprintf(buf, SERVER_STRING);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;Content-Type: text/html\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Method Not Implemented\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;&lt;/TITLE&gt;&lt;/HEAD&gt;\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;&lt;BODY&gt;&lt;P&gt;HTTP request method not supported.\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);</div><div class="line"> sprintf(buf, &quot;&lt;/BODY&gt;&lt;/HTML&gt;\r\n&quot;);</div><div class="line"> send(client, buf, strlen(buf), 0);*/</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3.make重新编译</p>
<p>4.运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./httpd</div></pre></td></tr></table></figure>
<p>运行结果全部成功</p>
<p><img src="http://img.blog.csdn.net/20160730214417824" alt="这里写图片描述"></p>
<p>[总结]<br>小小的预告！<br>下一篇会详细解释最后最综合的网络实验，从一开始搜bing到有时候科学上网google，再到后面看cnblog、csdn找到有用的答案或错误分享解决方案，到逐渐从github找到大神。</p>
<p>结论：最make sense的还是开发者的README.md，自己编的程序自己最清楚嘛，次之是github的大神或者stackflow。对英文有一定要求。至于bing、google搜出来的答案当然也会有用的但是鱼龙混杂，能找到有帮助但却浪费了一定时间。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yisiqiu.com/2016/07/27/CentOS-on-Mac-3-进程通信/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Izzy Qiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/profile.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Izzy Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/27/CentOS-on-Mac-3-进程通信/" itemprop="url">#CentOS on Mac#3.进程通信 </a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-27T21:49:40+08:00">
                2016-07-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>要求</strong>写两个进程A跟B<br>A：无限循环输出一个字符<br>B：入侵进程A，改变输出的字符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">#include &lt;sys/types.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">int main()</div><div class="line">&#123;</div><div class="line">    pid_t pid;  //进程号</div><div class="line">    char *message;</div><div class="line">    int n;</div><div class="line">    printf(&quot;Process starting\n&quot;);</div><div class="line">    pid = fork();</div><div class="line">    switch(pid)</div><div class="line">    &#123;</div><div class="line">    case -1:</div><div class="line">        perror(&quot;failed&quot;);</div><div class="line">        exit(1);</div><div class="line">    case 0:</div><div class="line">        message = &quot;Process A&quot;;</div><div class="line">        n = 10; //循环10次</div><div class="line">        break;</div><div class="line">    default:</div><div class="line">        message = &quot;Process B&quot;; //父进程</div><div class="line">        n = 4;</div><div class="line">        break;</div><div class="line">    &#125;</div><div class="line">    while(1) &#123;</div><div class="line">        puts(message);</div><div class="line">        sleep(1); //1s</div><div class="line">    &#125;</div><div class="line">    exit(0);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>gcc -o process process.c<br>./process</p>
<blockquote>
<p>ctrl+c 退出死循环</p>
</blockquote>
<p><img src="http://img.blog.csdn.net/20160727214907807" alt="这里写图片描述"></p>
<p><strong>1.进程B可以破坏隔离性，修改进程A输出的原因</strong></p>
<p> 调用fork可以创建一个全新的进程。<br> 这个系统调用对当前进程进行复制。在进程表里创建一个新的项目，许多属性与当前进程是相同的。新进程和原进程几乎一模一样，执行的也是相同的代码，但新进程有自己的数据空间、自己的环境等。</p>
<blockquote>
<p>程序调用了fork函数的时候被分成了两个进程。在父进程里，fork函数返回新进程的PID进程号，新进程则返回0，这个可以做为区分父子进程的依据。</p>
</blockquote>
<p><strong>2.进程通信的作用</strong></p>
<p>(1)数据传输：一个进程需要将它的数据发送给另一个进程<br>(2)共享数据：一个进程对共享数据的修改，别的进程应该立刻看到。<br>(3)通知事件：一个进程需要向另一个或一组进程发送消息，通知它（它们）发生了某种事件（如进程终止时要通知父进程）。<br>(4)资源共享：多个进程之间共享同样的资源，需要内核提供锁和同步机制。<br>(5)进程控制：有些进程希望完全控制另一个进程的执行（如Debug进程），此时控制进程希望能够拦截另一个进程的所有陷入和异常，并能够及时知道它的状态改变。</p>
<p><strong>3.隔离性与通信的平衡</strong></p>
<p>操作系统中，进程间是相互不可见的。操作系统在逻辑上将每个进程隔离开了。一个进程里是不可能看到真实的物理内存地址的。内存地址，都是虚拟内存地址，而不是真实的物理内存地址。每个进程的虚拟内存地址都是一样大的</p>
<p>进程间的内存相互隔绝，防止进程间的相互干扰。<br>假如A进程在操作一个内存时，B进程无意中程序执行出错，改写了A的进程的内存，A进程就很可能崩溃，从而造成了破坏。这也是保护各个进程的安全的一个手段。同时，操作系统也是有各种进程组成的。<br>系统的进程同样也会被其他进程进行破坏，既保护了用户程序安全，更是保护了操作系统本身，使操作系统变得很健壮。因为程序的操作都是在自己的虚拟地址空间中执行的，系统内部在执行时，总是可以将虚拟内存地址映射到进程的实际的内存地址区间而不会越界，从而避免了内存破坏问题。</p>
<p>(1) <strong>将进程相互隔绝，才会出现各种各样的通信机制。</strong><br>比如内存映射文件，将一个文件打开，作为通信中介，然后将这文件作为内核对象，分配一个句柄，这个是公用的文件，而这个句柄，是系统全部进程都可以看到的，并且看到的都是同一个，然后通过向系统请求，得到访问这个内核对象的句柄就可以操作了。操作完后，其他进程才可以操作，这个是“进程间的互斥”。而通过这种方式就可以更改公共的变量，达到通信的目的。而这个通信的过程就是内存映射文件模式。内核文件作为一个中介，让相互看不见的进程可以相互交换数据。</p>
<p>(2) <strong>管道，邮槽则也是通过消息信件机制，通过系统投递给进程的。</strong><br>进程只要接受这个信件即可，然后了解情况后再发送信件。系统成为了信使。这样也达到通信的机制。</p>
<p>这些也就解决了进程间相互不能通信的问题，也保证进程间相互隔绝后的安全。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yisiqiu.com/2016/07/27/2016开发热点词儿/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Izzy Qiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/profile.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Izzy Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/27/2016开发热点词儿/" itemprop="url">2016开发热点词儿</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-27T21:22:11+08:00">
                2016-07-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##What’sNewOnInternet<br>第一次到实验室听到这些词是一脸懵逼，我意识到如果要keep up with its development，掌握最新动态是必须的。所以开了这个tag，记录现在的热词。</p>
<ul>
<li>G363</li>
<li>homebrew</li>
<li>cocoapods</li>
<li>stackflow</li>
<li><p>parallels</p>
</li>
<li><p>Swift语言中struct和class</p>
</li>
<li>面向协议POP</li>
<li>MVC和MVVM</li>
<li>ReactiveCocoa</li>
<li>Github</li>
<li>clang swift llvm3.6</li>
<li>CMake语言</li>
<li>swift silver</li>
<li>ARC和MRC</li>
<li>UITableView的渲染顺序</li>
</ul>
<p>###G363<br>如果你不想科学上网，又想用最棒的引擎，用它准没错！</p>
<p>###homebrew<br>Homebrew是Mac OSX上的软件包管理工具，能在Mac中方便的安装软件或者卸载软件，可以说Homebrew就是mac下的apt-get、yum神器</p>
<blockquote>
<p>ruby -e “$(curl -fsSL<br><a href="https://raw.githubusercontent.com/Homebrew/install/master/install" target="_blank" rel="external">https://raw.githubusercontent.com/Homebrew/install/master/install</a>)”</p>
</blockquote>
<p><strong>具体使用</strong></p>
<blockquote>
<p>搜索软件：brew search //app</p>
<p>安装软件：brew install //app</p>
<p>卸载软件：brew remove //app</p>
</blockquote>
<p>###cocoapods</p>
<p>项目中会引用许多第三方库<br>所以cocoapods应运而生<br>详细教程：<br><a href="http://blog.csdn.net/showhilllee/article/details/38398119" target="_blank" rel="external">http://blog.csdn.net/showhilllee/article/details/38398119</a></p>
<hr>
<p>###stackflow<br>程序员界的知乎，热心的提问和回答吧！</p>
<p>###Parallels Desktop<br>答应我，装虚拟机先考虑这个好吗</p>
<p>###Swift语言中struct和class</p>
<ol>
<li><p>struct没有继承的功能而class是可以继承的，面向对象语言的核心能力</p>
</li>
<li><p>体现在内存使用上，struct是通过值传递，而class是通过引用传递的</p>
</li>
</ol>
<p>###POP</p>
<ul>
<li>Swift的核心是面向协议的编程。</li>
<li>面向协议的编程的核心是抽象（abstraction）和简化（simplicity）</li>
</ul>
<p>若太多子类继承了同一个父类，当父类有error时，后果难以置信。。</p>
<blockquote>
<p>protocol ErrorPopoverRenderer {<br>    func presentError()<br>}<br>extension ErrorPopoverRenderer where Self: UIViewController {<br>    func presentError() {<br>        //在这里加默认实现，并提供ErrorView的默认参数。<br>    }<br>}<br>class KrakenViewController: UIViewController, ErrorPopoverRenderer {<br>    func methodThatHasAnError() {<br>        //…<br>        //抛出error，原因是Kraken海妖今天吃人会感到不适。<br>        presentError() //Woohoo! 没有参数了！我们现在有默认实现了！<br>    }<br>}</p>
</blockquote>
<p>####VOP<br>值类型在任何时候只有一个享有者，从而降低复杂度。防止在任何时间点使用引用的话会带来的副作用。Class = 高复杂度，值类型 = 低复杂度。</p>
<blockquote>
<p>struct ErrorOptions {<br>    let message: String<br>    let showArrow: Bool<br>    let backgroundColor: UIColor<br>    let size: CGSize<br>    let canDismissByTap: Bool<br>    init(message: String = “Error!”, shouldShowArrow: Bool = true, backgroundColor: Color = Color(), size: CGSize = CGSizeZero, canDismissByTappingAnywhere canDismiss: Bool = true) {<br>        self.message = message<br>        self.showArrow = shouldShowArrow<br>        self.backgroundColor = backgroundColor<br>        self.size = size<br>        self.canDismissByTap = canDismiss<br>    }</p>
</blockquote>
<p><strong>所以</strong></p>
<blockquote>
<p>protocol ErrorPopoverRenderer {<br>    func presentError(errorOptions: ErrorOptions)<br>}<br>extension ErrorPopoverRenderer where Self: UIViewController {<br>    func presentError(errorOptions = ErrorOptions()) {<br>        //在这里加默认实现，并提供ErrorView的默认参数。<br>    }<br>}</p>
</blockquote>
<p>###MVC和MVVM</p>
<p>简单回顾一下MVC<br>各部分之间的通信方式如下。<br><img src="http://upload-images.jianshu.io/upload_images/1881209-f83a89173883122b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述"><br>View 传送指令到 Controller<br>Controller 完成业务逻辑后，要求 Model 改变状态<br>Model 将新的数据发送到 View，用户得到反馈</p>
<p>科普贴：<br><a href="http://www.ruanyifeng.com/blog/2015/02/mvcmvp_mvvm.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2015/02/mvcmvp_mvvm.html</a><br>MVVM 模式将 Presenter 改名为 ViewModel，基本上与 MVP 模式完全一致</p>
<p>前端工程师们与程序开发人员们实现了真正的分离，当然，为了减少重复代码量，前端人员有必要了解一个数据库结构。</p>
<p>前端进行MVVM的JS插件，knockoutjs</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1881209-7aa6fd119065e3fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述"></p>
<p>唯一的区别是，它采用双向绑定（data-binding）：View的变动，自动反映在 ViewModel，反之亦然。<a href="https://angularjs.org/" target="_blank" rel="external">Angular</a> 和 <a href="http://emberjs.com/" target="_blank" rel="external">Ember</a> 都采用这种模式。</p>
<p>附上MVP<br>MVP 模式将 Controller 改名为 Presenter，同时改变了通信方向。<br><img src="http://upload-images.jianshu.io/upload_images/1881209-cab302f0e9d56c85.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述"></p>
<ol>
<li>各部分之间的通信，都是双向的。</li>
<li>View 与 Model 不发生联系，都通过 Presenter 传递。</li>
<li>View 非常薄，不部署任何业务逻辑，称为”被动视图”（Passive View），即没有任何主动性，而 Presenter非常厚，所有逻辑都部署在那里。</li>
</ol>
<p>如果你想系统的学习MVVM，了解DataSource跟Delegate一定要好好看这系列文章<br><a href="https://www.objc.io/issues/13-architecture/mvvm/" target="_blank" rel="external">https://www.objc.io/issues/13-architecture/mvvm/</a></p>
<p>###ReactiveCocoa</p>
<ul>
<li><p>在我们iOS开发过程中，当某些事件响应的时候，需要处理某些业务逻辑,这些事件都用不同的方式来处理。</p>
</li>
<li><p>比如按钮的点击使用action，ScrollView滚动使用delegate，属性值改变使用KVO等系统提供的方式。<br>其实这些事件，都可以通过RAC处理</p>
</li>
<li><p>ReactiveCocoa为事件提供了很多处理方法，而且利用RAC处理事件很方便，可以把要处理的事情，和监听的事情的代码放在一起，这样非常方便我们管理，就不需要跳到对应的方法里。非常符合我们开发中高聚合，低耦合的思想。</p>
</li>
</ul>
<p>ReactiveCocoa结合了几种编程风格：</p>
<ul>
<li><p>函数式编程（Functional Programming）</p>
</li>
<li><p>响应式编程（Reactive Programming）</p>
</li>
</ul>
<p>所以，你可能听说过ReactiveCocoa被描述为函数响应式编程（FRP）框架。</p>
<p>以后使用RAC解决问题，就不需要考虑调用顺序，直接考虑结果，把每一次操作都写成一系列嵌套的方法中，使代码高聚合，方便管理。</p>
<ul>
<li><p>信号类(RACSiganl)，只是表示当数据改变时，信号内部会发出数据，它本身不具备发送信号的能力，而是交给内部一个订阅者去发出。</p>
</li>
<li><p>默认一个信号都是冷信号，也就是值改变了，也不会触发，只有订阅了这个信号，这个信号才会变为热信号，值改变了才会触发。</p>
</li>
<li><p>如何订阅信号：调用信号RACSignal的subscribeNext就能订阅。</p>
</li>
</ul>
<p>原文链接：<a href="http://www.jianshu.com/p/87ef6720a096" target="_blank" rel="external">http://www.jianshu.com/p/87ef6720a096</a></p>
<p><strong>信号会为了控制通过应用的信息流而获得所有这些异步方法</strong>(委托, 回调 block, 通知, KVO, target/action 事件观察, 等)并将它们统一到一个接口下.这只是直观理解. 不仅是这些, 因为信息会流过你的应用, 它还提供给你轻松转换/分解/合并/过滤信息的能力.<br><img src="http://upload-images.jianshu.io/upload_images/1881209-d9d36bc649f0c53b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述"><strong>那么什么是信号呢?这是一个信号:</strong><br><img src="http://upload-images.jianshu.io/upload_images/1881209-6e5653cd4fe78781.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述"></p>
<p><strong>ReactiveCocoa signal（RACSignal）</strong>发送事件流给它的subscriber。目前总共有三种类型的事件：<strong>next、error、completed</strong>。一个signal在因error终止或者完成前，可以发送任意数量的next事件。</p>
<p>在登录界面中，你可以这样用</p>
<p> 监听文本框文字改变:<br>rac_textSignal:只要文本框发出改变就会发出这个信号。<br><img src="http://upload-images.jianshu.io/upload_images/1881209-b3a78d6d9b35eea7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述"></p>
<p>一句话，核心就是信号，block一定要学好</p>
<p>###Github<br>git太好用了不多说</p>
<p>###clang swift llvm3.6<br> Low Level Virtual Machine 的简称，这个库提供了与编译器相关的支持，能够进行程序语言的编译期优化、链接优化、在线编译优化、代码生成，可以作为多种语言编译器的后台来使用。<br>Clang 是一个 C++ 编写、基于 LLVM、发布于 LLVM BSD 许可证下的 C/C++/Objective C/Objective C++ 编译器，其目标（之一）就是超越 GCC。</p>
<p>好在哪？</p>
<ol>
<li>快：通过编译 OS X 上几乎包含了所有 C 头文件的 carbon.h 的测试，包括预处理 (Preprocess)，语法 (lex)，解析 (parse)，语义分析 (Semantic Analysis)，抽象语法树生成 (Abstract Syntax Tree) 的时间，Clang 是 Apple GCC 4.0 的 2.5x 快。(2007-7-25)</li>
<li>内存占用小：Clang 内存占用是源码的 130%，Apple GCC 则超过 10x。</li>
<li>GCC 兼容性。<br>设计清晰简单，容易理解，易于扩展增强。</li>
<li>基于库的模块化设计，易于 IDE 集成及其他用途的重用。</li>
</ol>
<p>由于历史原因，GCC 是一个单一的可执行程序编译器，其内部完成了从预处理到最后代码生成的全部过程，中间诸多信息都无法被其他程序重用。<br>Clang 将编译过程分成彼此分离的几个阶段，AST 信息可序列化。通过库的支持，程序能够获取到 AST 级别的信息，将大大增强对于代码的操控能力。对于 IDE 而言，代码补全、重构是重要的功能，然而如果没有底层的支持，只使用 tags 分析或是正则表达式匹配是很难达成的。</p>
<h3 id="CMake语言"><a href="#CMake语言" class="headerlink" title="CMake语言"></a>CMake语言</h3><p>CMake是一个跨平台的安装(编译)工具,可以用简单的语句来描述所有平台的安装(编译过程)。他能够输出各种各样的makefile或者project文件,能测试编译器所支持的C++特性,类似UNIX下的automake。</p>
<p><strong>CMake 使用方法</strong><br>CMake的所有的语句都写在一个叫:CMakeLists.txt 的文件中。当CMakeLists.txt文件确定后,可以用ccmake命令对相关 的变量值进行配置。这个命令必须指向CMakeLists.txt所在的目录。配置完成之后,应用cmake命令生成相应的makefile（在Unix like系统下）或者 project文件（指定用window下的相应编程工具编译时）。</p>
<blockquote>
<p>project(HELLO)<br>set(SRC_LIST main.c)<br>add_executable(hello ${SRC_LIST})</p>
</blockquote>
<h3 id="swift-silver"><a href="#swift-silver" class="headerlink" title="swift silver"></a>swift silver</h3><p>诸如AppCode、PaintCode、Quick等开发、设计与测试工具已完全支持Swift，而跨平台工具Apportable也已支持使用Swift开发iOS和Android原生应用，如今，又有一款名为<strong>Silver</strong>颇为强劲的工具让开发者可以直接使用Swift语言来编写iOS、Android、Windows应用。<br><a href="http://elementscompiler.com/elements/silver/" target="_blank" rel="external">Silver编译器</a>能编译Swift代码运行在.NET和Java运行时上。开发Silver的公司RemObjects不允许开发者利用它开发完整的跨平台应用，理由是用户界面应该原生开发</p>
<h3 id="ARC和MRC"><a href="#ARC和MRC" class="headerlink" title="ARC和MRC"></a>ARC和MRC</h3><ol>
<li><strong> Objective-c语言中的MRC（MannulReference Counting）</strong></li>
</ol>
<p>在MRC的内存管理模式下，与对变量的管理相关的方法有：retain,release和autorelease。retain和release方法操作的是引用记数，当引用记数为零时，便自动释放内存。并且可以用NSAutoreleasePool对象，对加入自动释放池（autorelease调用）的变量进行管理，当drain时回收内存。</p>
<p>（1）      retain，该方法的作用是将内存数据的所有权附给另一指针变量，引用数加1，即retainCount+= 1;</p>
<p>（2）      release，该方法是释放指针变量对内存数据的所有权，引用数减1，即retainCount-= 1;</p>
<p>（3）      autorelease，该方法是将该对象内存的管理放到autoreleasepool中。</p>
<ol>
<li><strong>Objective-c语言中的<br>ARC（AutomaticReference Counting）</strong></li>
</ol>
<p>在ARC中与内存管理有关的标识符，可以分为变量标识符和属性标识符，对于变量默认为__strong，而对于属性默认为unsafe_unretained。也存在autoreleasepool。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1881209-00865cca678a17b8.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述"><br>  MRC与ARC区别示意图</p>
<hr>
<p>事实上，ARC可能比MRC更慢，但我们还是尽可能使用它，因为他让我们不用过多关心内存的问题。<br>性能比较分析：<a href="http://stackoverflow.com/questions/12527286/are-there-any-concrete-study-of-the-performance-impact-of-using-arc" target="_blank" rel="external">http://stackoverflow.com/questions/12527286/are-there-any-concrete-study-of-the-performance-impact-of-using-arc</a></p>
<h3 id="UITableView的渲染顺序"><a href="#UITableView的渲染顺序" class="headerlink" title="UITableView的渲染顺序"></a>UITableView的渲染顺序</h3><ol>
<li>numberOfRowsInSection  每个section中有多少行cell</li>
<li>heightForRowAtIndexPath   每个cell的高度</li>
<li>cellForRowAtIndexPath    每个cell中的内容  </li>
<li>tableview 根据cell的个数，高度，内容来进行自动布局</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yisiqiu.com/2016/07/27/CentOS-on-Mac-2-加入系统调用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Izzy Qiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/profile.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Izzy Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/27/CentOS-on-Mac-2-加入系统调用/" itemprop="url">#CentOS on Mac#2.加入系统调用 </a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-27T12:15:22+08:00">
                2016-07-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>实验要求：</strong><br>1.加入系统调用，在终端输出信息<br>2.编写用户态程序，运行输出</p>
<p><strong>实验步骤</strong><br>1.修改实验一的源码<br>终端进入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/src/linux-4.6.4/usr/include/asm/unistd_64.h</div></pre></td></tr></table></figure>
<p>这里64是64位，32位应为32</p>
<p>2.修改系统调用号<br><img src="http://img.blog.csdn.net/20160727120112763" alt="查询系统调用号，不同的系统号不同，应该为未使用过的"><br>define __NR_yssyscall 329</p>
<p>查询系统调用号，不同的系统号不同，应该为未使用过的</p>
<p>3.简单起见按照第一篇文章的函数修改sys.c文件<br><code>gedit /usr/src/linux-4.6.4/kernel/sys.c</code></p>
<p>在文件最后添加函数（功能为输出姓名学号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">asmlinkage int sys_yssyscall(void)</div><div class="line">&#123;</div><div class="line">printk(&quot;qyisi 20142100”);</div><div class="line">return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>4.加入 define __NR_yssyscall 329</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd /usr/src/linux-4.6.4/arch/x86/entry/syscalls</div><div class="line"></div><div class="line">gedit syscall_64.tbl</div></pre></td></tr></table></figure>
<p>我的电脑里syscall_64.tbl的位置很奇怪，若找不到搜索一下就好了<br>同理，若是32位即找对应的tbl文件</p>
<p>5.make menuconfig<br>详细介绍</p>
<p><a href="http://blog.csdn.net/xuyuefei1988/article/details/8635539" target="_blank" rel="external">http://blog.csdn.net/xuyuefei1988/article/details/8635539</a></p>
<p>6.重新编译内核</p>
<p><strong>清除上次痕迹 make mrproper</strong><br><img src="http://img.blog.csdn.net/20160727122656533" alt="这里写图片描述"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">make</div><div class="line">make modules</div><div class="line">make modules_install</div><div class="line">make install</div></pre></td></tr></table></figure>
<p>编译<br><img src="http://img.blog.csdn.net/20160727122801185" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160727122818723" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160727122828638" alt="这里写图片描述"></p>
<p>7.reboot 重新启动 进入新内核<br><img src="http://img.blog.csdn.net/20160727122929358" alt="这里写图片描述"></p>
<p>8.编写用户态文件</p>
<p>在主文件目录（/home）下创建文件夹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir test</div></pre></td></tr></table></figure>
<p>进入/home/test/目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd test</div></pre></td></tr></table></figure>
<p>(1)创建文件test.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gedit test.c</div></pre></td></tr></table></figure>
<p>代码如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">#define __NR_yssyscall 329</div><div class="line">int main()</div><div class="line">&#123;</div><div class="line">int rs;</div><div class="line">rs = syscall(__NR_yssyscall);</div><div class="line">if (!rs)</div><div class="line">printf(&quot;qyisi 20142100&quot;);</div><div class="line">return 0&#125;</div></pre></td></tr></table></figure></p>
<p>(2)执行命令编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc –o test test.c</div></pre></td></tr></table></figure>
<p>(3)编译成功后<br><code>./testHello</code></p>
<p>(4)查看内核日志<br>查看系统调用在内核空间的运行情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dmesg</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160727123415935" alt="这里写图片描述"></p>
<p><strong>思考问题</strong></p>
<blockquote>
<p>“什么是操作系统的系统调用（system call）？系统调用过多会引起进程的性能开销么？为什么？”</p>
</blockquote>
<p>Linux内核中设置了一组用于实现各种系统功能的子程序，称为系统调用。<br>用户可以通过系统调用命令在自己的应用程序中调用它们。系统调用和普通的函数调用非常相似。</p>
<p>区别仅仅在于，系统调用由操作系统核心提供，运行于核心态；而普通的函数调用由函数库或用户自己提供，运行于用户态。系统调用过多会引起进程的性能开销，因为系统调用需要从用户空间陷入内核空间，处理完后，又需要返回用户空间。其中除了系统调用服务例程的实际耗时外，陷入/返回过程和系统调用处理程序（查系统调用表、存储\恢复用户现场）也需要花销一些时间，这些时间加起来就是一个系统调用的响应速度。</p>
<p>系统调用对性能要求很苛刻，因为它需要陷入内核执行，所以和其他内核程序一样要求代码简洁、执行迅速。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yisiqiu.com/2016/07/18/CentOS-on-Mac-1-Linux环境配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Izzy Qiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/profile.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Izzy Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/18/CentOS-on-Mac-1-Linux环境配置/" itemprop="url">#CentOS on Mac#1.Linux环境配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-18T17:07:54+08:00">
                2016-07-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前因为老师建议在Linux上跑perfect 就用pd装了Ubuntu，了解并不深入仅仅停留在简单命令git wget vim这些，从网上简要比较Ubuntu和CentOS的区别</p>
<p>####1.Ubuntu<br>图形界面漂亮，它最佳的应用领域是桌面操作系统而非服务器操作系统。仅仅安装在自己的电脑中而非服务器中，Ubuntu并没有在VPS安装的操作系统选择之列</p>
<p>####2.CentOS<br>非常多的商业公司部署在生产环境上的服务器都是使用CentOS系统，CentOS是从RHEL源代码编译的社区重新发布版。CentOS简约，命令行下的人性化做得比较好，稳定，有着强大的英文文档与开发社区的支持。与Redhat有着相同的渊源。虽然不单独提供商业支持，但往往可以从Redhat中找到一丝线索。相对Debian来说，CentOS略显体积大一点。是一个非常成熟的Linux发行版。</p>
<p>CentOS 7 <strong>配置设备</strong></p>
<p>MacBook Pro (13’’)<br>处理器2.7 GHz Intel Core i5<br>内存8GB 1867 MHz DDr3<br>存储128G</p>
<p>虚拟机Parallels Desktop 11 - CentOS 7</p>
<ol>
<li>获取CentOS -7.0-64位ISO镜像文件，压缩包2G，解压后5.7G 安装成功<img src="http://img.blog.csdn.net/20160718170129484" alt="这里写图片描述"></li>
</ol>
<p>uname 还可以用来查版本</p>
<p>2.在www.kernel.org 获取 stable版本 4.6.4（release 20160711）</p>
<p><img src="http://img.blog.csdn.net/20160718170044015" alt="这里写图片描述"></p>
<p><strong>1.下载内核源码（用http协议下载）</strong><br>wget <a href="https://www.kernel.org/pub/linux/kernel/v4.x/linux-4.6.4.tar.xz" target="_blank" rel="external">https://www.kernel.org/pub/linux/kernel/v4.x/linux-4.6.4.tar.xz</a><br>输入wget后，404 Not Found 网址有错误，我将v4.x写成4.6<br>后来用浏览器获取地址后解决了问题</p>
<p><img src="http://img.blog.csdn.net/20160718170157000" alt="这里写图片描述"></p>
<p>加个小步骤 改正root权限 方便后面的操作<br>方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">（1）sudo passwd root //修改root密码</div><div class="line">跟着步骤重设新的root密码</div><div class="line">（2）su root 切换到root密码 输入新密码</div><div class="line">（3）打开vim vi /etc/sudoers</div><div class="line">修改文件 找到## all members of group</div><div class="line">                     wheel ...这句</div><div class="line">将wheel前的#注释去掉</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160718170322813" alt="这里写图片描述"><br>plus常用vim指令<br><strong>开始用i进行插入，x删除，：wq为保存退出若为只读文件，：wq!强制保存exit</strong></p>
<p><strong>2.解压文件并移动到/usr/src/</strong><br>tar.xz 对应的解压指令为-jxvf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#tar -jxvf linux-4.6.4.tar.xz</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160718170501189" alt="这里写图片描述"><br>&gt;<br>tar xvf将目标文件或目录解包<br>tar cvf 将目录下的文件或目录打成tar包<br>tar zxvf将目录或文件解压缩并解包<br>tar zcvf将目录或文件打成tar包并压缩]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># cd /usr/src/linux-4.6.4</div></pre></td></tr></table></figure>
<p>进入文件夹内</p>
<p> !<strong>!清理以前的编译痕迹</strong><br>如果内核源码是刚解压缩出来的，可以跳过这一步，否则执行以下两条命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">make mrproper</div><div class="line">make clean</div></pre></td></tr></table></figure>
<p><strong>3.设置内核编译选项</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make menuconfig</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160718170226623" alt="这里写图片描述"><br>执行该命令需要ncurses库，如果执行出错则执行如下命令安装ncurses：（Ncurses 提供字符终端处理库，包括面板和菜单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install ncurses-devel</div><div class="line">yum -y install gcc</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160718170412704" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160718170704064" alt="这里写图片描述"><br>错误：一开始提示找不到openssl 用了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo yum install openssl-devel</div></pre></td></tr></table></figure>
<p>//编译内核压缩镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make bzImage</div></pre></td></tr></table></figure>
<p>编译会生成bzImage文件，对应于/boot目录下的vmlinuz文件，是压缩过的内核文件。启动加载时将该文件解压缩到内存中之后才能执行操作系统。</p>
<p><strong>4.编译内核模块</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">make   </div><div class="line">make modules_install</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160718170725940" alt="这里写图片描述"><br>内核在运行过程中，除需要内核文件之外，还需要加载一些外围模块（例如驱动程序）等才能运行。<br> 安装内核模块</p>
<p>一般都会安装到/lib/modules目录下。</p>
<p><strong>5.安装内核</strong></p>
<p>make install<br>这句命令很简单，它会在/boot目录下生成vmlinux/System.map两个文件，并且在/boot/grub目录中生成menu.lst／grub.conf文件。</p>
<p>注：要是遇到找不到内核模块的错误，执行以下两个命令<br>cp arch/x86/boot/bzImage /boot/vmlinuz-4.6.4<br>cp System.map /boot/System.map-4.6.4</p>
<p>算一算时间</p>
<p>＃ time make<br><img src="http://img.blog.csdn.net/20160718170609127" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20160718170622284" alt="这里写图片描述"></p>
<p>6.<strong>修改启动顺序</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/boot/grub/grub.conf default=0</div></pre></td></tr></table></figure>
<p><strong>7.reboot</strong></p>
<p>问题与解决方法：<br>之前出现了无法换内核的现象No valid domains in Package 0<br>将空白的grub.conf写满（各个机子的文件都差不多</p>
<blockquote>
<p>1.如何在多核环境加速linux编译</p>
</blockquote>
<p>［转载］<br> <strong>tmpfs</strong><br>有人说在Windows下用了RAMDisk把一个项目编译时间从4.5小时减少到了5分钟,把文件放到内存上做编译应该是比在磁盘上快多了吧，尤其如果编译器需要生成很多临时文件的话。<br>这个做法的实现成本最低，在Linux中，直接mount一个tmpfs就可以了。而且对所编译的工程没有任何要求，也不用改动编译环境。</p>
<blockquote>
<p>mount -t tmpfs tmpfs ~/build -o size=1G</p>
</blockquote>
<p>用2.6.32.2的Linux Kernel来测试一下编译速度：<br>用物理磁盘：40分16秒<br>用tmpfs：39分56秒<br>看来编译慢很大程度上瓶颈并不在IO上面。但对于一个实际项目来说，编译过程中可能还会有打包等IO密集的操作，所以只要可能，用tmpfs是有益无害的。当然对于大项目来说，需要有足够的内存才能负担得起这个tmpfs的开销。</p>
<p><strong>make -j</strong></p>
<p>那CPU就应该是一个影响编译速度的重要因素了。<br>用make -j带一个参数，项目进行<strong>并行编译</strong><br>比如在一台双核的机器上，完全可以用make -j4，让make最多允许4个编译命令同时执行，这样可以更有效的利用CPU资源。<br>还是用Kernel来测试：<br>用make： 40分16秒<br>用make -j4：23分16秒<br>用make -j8：22分59秒<br>在多核CPU上，适当的进行并行编译还是可以明显提高编译速度的。但并行的任务不宜太多，一般是以CPU的核心数目的两倍为宜。</p>
<blockquote>
<p>如果项目的Makefile不规范，没有正确的设置好依赖关系，并行编译的结果就是编译不能正常进行。如果依赖关系设置过于保守，则可能本身编译的可并行度就下降了，也不能取得最佳的效果。</p>
</blockquote>
<p><strong>ccache</strong><br>ccache用于把编译的中间结果进行缓存，以便在再次编译的时候可以节省时间。再重新编译，而这两次编译大部分东西可能都没有发生变化。对于平时开发项目来说，也是一样。为什么不是直接用make所支持的增量编译呢？还是因为现实中，因为Makefile的不规范，很可能这种“聪明”的方案根本不能正常工作<br>只有每次make clean再make才行。</p>
<blockquote>
<p>安装完ccache后，可以在/usr/local/bin下建立gcc，g++，c++，cc的symbolic<br>link，链到/usr/bin/ccache上。总之确认系统在调用gcc等命令时会调用到ccache就可以了（通常情况下/usr/local/bin会在PATH中排在/usr/bin前面）。</p>
</blockquote>
<p>继续测试：<br>用ccache的第一次编译(make -j4)：23分38秒<br>用ccache的第二次编译(make -j4)：8分48秒<br>用ccache的第三次编译(修改若干配置，make -j4)：23分48秒<br>修改配置对ccache的影响是很大的，因为基本头文件发生变化后，就导致所有缓存数据都无效了，必须重头来做。但如果只是修改一些.c文件的代码，ccache的效果还是相当明显的。而且使用ccache对项目没有特别的依赖，布署成本很低，这在日常工作中很实用。</p>
<blockquote>
<p>ccache -s</p>
</blockquote>
<p>来查看cache的使用和命中情况：<br>cache directory                   /home/lifanxi/.ccache<br>cache hit                           7165<br>cache miss                         14283<br>called for link                       71<br>not a C/C++ file                     120<br>no input file                       3045<br>files in cache                     28566<br>cache size                          81.7 Mbytes<br>max cache size                     976.6 Mbytes<br>可以看到，显然只有第二编次译时cache命中了，cache miss是第一次和第三次编译带来的。两次cache占用了81.7M的磁盘，还是完全可以接受的。</p>
<p><strong>distcc</strong></p>
<p>使用distcc，只要求源代码可以用make -j并行编译，并且参与分布式编译的电脑系统中具有相同的编译器。因为它的原理只是把预处理好的源文件分发到多台计算机上，预处理、编译后的目标文件的链接和其它除编译以外的工作仍然是在发起编译的主控电脑上完成，所以只要求发起编译的那台机器具备一套完整的编译环境就可以了。<br>distcc安装后，可以启动一下它的服务：</p>
<blockquote>
<p>/usr/bin/distccd  –daemon –allow 10.64.0.0/16</p>
</blockquote>
<p>默认的3632端口允许来自同一个网络的distcc连接。<br>然后设置一下DISTCC_HOSTS环境变量，设置可以参与编译的机器列表。通常localhost也参与编译</p>
<blockquote>
<p>export DISTCC_HOSTS=&quot;localhost 10.64.25.1 10.64.25.2 10.64.25.3&quot;</p>
</blockquote>
<p>然后与ccache类似把g++，gcc等常用的命令链接到/usr/bin/distcc上就可以了。<br>在make的时候，也必须用-j参数，一般是参数可以用所有参用编译的计算机CPU内核总数的两倍做为并行的任务数。<br>同样测试一下：<br>一台双核计算机，make -j4：23分16秒<br>两台双核计算机，make -j4：16分40秒<br>两台双核计算机，make -j8：15分49秒</p>
<p>在编译过程中</p>
<blockquote>
<p>distccmon-text</p>
</blockquote>
<p>来查看编译任务的分配情况。distcc也可以与ccache同时使用，通过设置一个环境变量就可以做到，非常方便。<br>总结一下：</p>
<blockquote>
<p>tmpfs： 解决IO瓶颈，充分利用本机内存资源<br>make -j： 充分利用本机计算资源<br> distcc： 利用多台计算机资源<br> ccache：减少重复编译相同代码的时间</p>
</blockquote>
<p><strong>常用内核编译器</strong><br>gcc</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yisiqiu.com/2016/04/08/Swift-Ubuntu-on-Mac/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Izzy Qiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/profile.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Izzy Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/04/08/Swift-Ubuntu-on-Mac/" itemprop="url">Ubuntu on Mac</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-04-08T23:23:26+08:00">
                2016-04-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index">
                    <span itemprop="name">Tech</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>本周任务：让swift在linux上跑起来</p>
<ul>
<li><strong>在MacBook Pro Retina上装Linux</strong><br>Parallels + Ubuntu 14.04</li>
<li><strong>在Linux上安装Swift</strong></li>
</ul>
<hr>
<p>##Parallels + Ubuntu 14.04</p>
<ul>
<li>虚拟机 or Bootcamp?</li>
</ul>
<p>－虚拟机<strong>优点</strong>：不需要重启切换系统；可以安装多个系统；不需要分区等等。最酷炫的就是两个系统同时出现在桌面<br> －虚拟机<strong>缺点</strong>：不适合大型游戏，跑极占内存的应用</p>
<p>一般网上的黑苹果教学是用VMare Fusion, 这里我用的是<strong>Parallels Desktop 11</strong>。两者相差不大，硬要比较的话，Parallels Desktop稍占优势。网上也有详细的对比贴，传送门：<em>Parallels Desktop 10 与 VMware Fusion 7 性能对比测试</em>   <a href="http://www.macx.cn/thread-2138678-1-1.html" target="_blank" rel="external">http://www.macx.cn/thread-2138678-1-1.html</a></p>
<ul>
<li><p>哪个发行版的Linux适合我？</p>
<ul>
<li><p>UBUNTU 适合新手，稳定的官方支持</p>
</li>
<li><p>Debian UBUNTU进阶发行版，包管理系统稳定，易上手</p>
</li>
<li><p>Arch 包更新相当快，滚动升级，系统一定最新</p>
</li>
<li><p>LFS 终极黑客显摆工具，从源代码安装，编译系统，照文档一步步去构建你的Linux。</p>
</li>
</ul>
</li>
</ul>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/04/08/Swift-Ubuntu-on-Mac/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/profile.jpg"
               alt="Izzy Qiu" />
          <p class="site-author-name" itemprop="name">Izzy Qiu</p>
           
              <p class="site-description motion-element" itemprop="description">A girl with a laptop</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/yzziqiu" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/shwarc" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Izzy Qiu</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
